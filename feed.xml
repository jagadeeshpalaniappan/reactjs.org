<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[React]]></title><description><![CDATA[A JavaScript library for building user interfaces]]></description><link>https://reactjs.org</link><generator>RSS for Node</generator><lastBuildDate>Tue, 16 Oct 2018 18:34:42 GMT</lastBuildDate><item><title><![CDATA[Create React App 2.0: Babel 7, Sass, and More]]></title><description><![CDATA[<p>Create React App 2.0 has been released today, and it brings a year’s worth of improvements in a single dependency update.</p>
<p>While React itself <a href="/reactdoc/docs/create-a-new-react-app.html">doesn’t require any build dependencies</a>, it can be challenging to write a complex app without a fast test runner, a production minifier, and a modular codebase. Since the very first release, the goal of <a href="https://github.com/facebook/create-react-app">Create React App</a> has been to help you focus on what matters the most — your application code — and to handle build and testing setup for you.</p>
<p>Many of the tools it relies on have since released new versions containing new features and performance improvements: <a href="https://babeljs.io/blog/2018/08/27/7.0.0">Babel 7</a>, <a href="https://medium.com/webpack/webpack-4-released-today-6cdb994702d4">webpack 4</a>, and <a href="https://jestjs.io/blog/2018/05/29/jest-23-blazing-fast-delightful-testing.html">Jest 23</a>. However, updating them manually and making them work well together takes a lot of effort. And this is exactly what <a href="https://github.com/facebook/create-react-app/graphs/contributors">Create React App 2.0 contributors</a> have been busy with for the past few months: <strong>migrating the configuration and dependencies so that you don’t need to do it yourself.</strong></p>
<p>Now that Create React App 2.0 is out of beta, let’s see what’s new and how you can try it!</p>
<blockquote>
<p>Note</p>
<p>Don’t feel pressured to upgrade anything. If you’re satisfied with the current feature set, its performance, and reliability, you can keep using the version you’re currently at! It might also be a good idea to let the 2.0 release stabilize a little bit before switching to it in production.</p>
</blockquote>
<h2 id="whats-new"><a href="#whats-new" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What’s New</h2>
<p>Here’s a short summary of what’s new in this release:</p>
<ul>
<li>🎉 More styling options: you can use <a href="https://github.com/facebook/create-react-app/blob/master/packages/react-scripts/template/README.md#adding-a-sass-stylesheet">Sass</a> and <a href="https://github.com/facebook/create-react-app/blob/master/packages/react-scripts/template/README.md#adding-a-css-modules-stylesheet">CSS Modules</a> out of the box.</li>
<li>🐠 We updated to <a href="https://babeljs.io/blog/2018/08/27/7.0.0">Babel 7</a>, including support for the <a href="/reactdoc/docs/fragments.html#short-syntax">React fragment syntax</a> and many bugfixes.</li>
<li>📦 We updated to <a href="https://medium.com/webpack/webpack-4-released-today-6cdb994702d4">webpack 4</a>, which automatically splits JS bundles more intelligently.</li>
<li>🃏 We updated to <a href="https://jestjs.io/blog/2018/05/29/jest-23-blazing-fast-delightful-testing.html">Jest 23</a>, which includes an <a href="https://jestjs.io/blog/2018/05/29/jest-23-blazing-fast-delightful-testing#interactive-snapshot-mode">interactive mode</a> for reviewing snapshots.</li>
<li>💄 We added <a href="https://preset-env.cssdb.org/features#stage-3">PostCSS</a> so you can use new CSS features in old browsers.</li>
<li>💎 You can use <a href="https://github.com/leoasis/graphql-tag.macro#usage">Apollo</a>, <a href="https://github.com/facebook/relay/pull/2171#issuecomment-411459604">Relay Modern</a>, <a href="https://github.com/facebook/create-react-app/issues/5149#issuecomment-425396995">MDX</a>, and other third-party <a href="https://babeljs.io/blog/2017/09/11/zero-config-with-babel-macros">Babel Macros</a> transforms.</li>
<li>🌠 You can now <a href="https://github.com/facebook/create-react-app/blob/master/packages/react-scripts/template/README.md#adding-svgs">import an SVG as a React component</a>, and use it in JSX.</li>
<li>🐈 You can try the experimental <a href="https://github.com/yarnpkg/rfcs/pull/101">Yarn Plug’n’Play mode</a> that removes <code class="gatsby-code-text">node_modules</code>.</li>
<li>🕸 You can now <a href="https://github.com/facebook/create-react-app/blob/master/packages/react-scripts/template/README.md#configuring-the-proxy-manually">plug your own proxy implementation</a> in development to match your backend API.</li>
<li>🚀 You can now use <a href="https://github.com/sindresorhus/ama/issues/446#issuecomment-281014491">packages written for latest Node versions</a> without breaking the build.</li>
<li>✂️ You can now optionally get a smaller CSS bundle if you only plan to target modern browsers.</li>
<li>👷‍♀️ Service workers are now opt-in and are built using Google’s <a href="https://developers.google.com/web/tools/workbox/">Workbox</a>.</li>
</ul>
<p><strong>All of these features work out of the box</strong> — to enable them, follow the below instructions.</p>
<h2 id="starting-a-project-with-create-react-app-20"><a href="#starting-a-project-with-create-react-app-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Starting a Project with Create React App 2.0</h2>
<p>You don’t need to update anything special. Starting from today, when you run <code class="gatsby-code-text">create-react-app</code> it will use the 2.0 version of the template by default. Have fun!</p>
<p>If you want to <strong>use the old 1.x template</strong> for some reason, you can do that by passing <code class="gatsby-code-text">--scripts-version=react-scripts@1.x</code> as an argument to <code class="gatsby-code-text">create-react-app</code>.</p>
<h2 id="updating-a-project-to-create-react-app-20"><a href="#updating-a-project-to-create-react-app-20" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Updating a Project to Create React App 2.0</h2>
<p>Upgrading a non-ejected project to Create React App 2.0 should usually be straightforward. Open <code class="gatsby-code-text">package.json</code> in the root of your project and find <code class="gatsby-code-text">react-scripts</code> there.</p>
<p>Then change its version to <code class="gatsby-code-text">2.0.3</code>:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx">  <span class="token comment">// ... other dependencies ...</span>
<span class="gatsby-highlight-code-line">  <span class="token string">"react-scripts"</span><span class="token punctuation">:</span> <span class="token string">"2.0.3"</span>
</span></code></pre></div>
<p>Run <code class="gatsby-code-text">npm install</code> (or <code class="gatsby-code-text">yarn</code>, if you use it). <strong>For many projects, this one-line change is sufficient to upgrade!</strong></p>
<blockquote class="twitter-tweet" data-conversation="none" data-dnt="true"><p lang="en" dir="ltr">working here... thanks for all the new functionality 👍</p>&mdash; Stephen Haney (@sdothaney) <a href="https://twitter.com/sdothaney/status/1046822703116607490?ref_src=twsrc%5Etfw">October 1, 2018</a></blockquote>
<p>Here’s a few more tips to get you started.</p>
<p><strong>When you run <code class="gatsby-code-text">npm start</code> for the first time after the upgrade,</strong> you’ll get a prompt asking about which browsers you’d like to support. Press <code class="gatsby-code-text">y</code> to accept the default ones. They’ll be written to your <code class="gatsby-code-text">package.json</code> and you can edit them any time. Create React App will use this information to produce smaller or polyfilled CSS bundles depending on whether you target modern browsers or older browsers.</p>
<p><strong>If <code class="gatsby-code-text">npm start</code> still doesn’t quite work for you after the upgrade,</strong> <a href="https://github.com/facebook/create-react-app/releases/tag/v2.0.3">check out the more detailed migration instructions in the release notes</a>. There <em>are</em> a few breaking changes in this release but the scope of them is limited, so they shouldn’t take more than a few hours to sort out. Note that <strong><a href="https://github.com/facebook/create-react-app/blob/next/packages/react-app-polyfill/README.md">support for older browsers</a> is now opt-in</strong> to reduce the polyfill size.</p>
<p><strong>If you previously ejected but now want to upgrade,</strong> one common solution is to find the commits where you ejected (and any subsequent commits changing the configuration), revert them, upgrade, and later optionally eject again. It’s also possible that the feature you ejected for (maybe Sass or CSS Modules?) is now supported out of the box.</p>
<blockquote>
<p>Note</p>
<p>Due to a possible bug in npm, you might see warnings about unsatisfied peer dependencies. You should be able to ignore them. As far as we’re aware, this issue isn’t present with Yarn.</p>
</blockquote>
<h2 id="breaking-changes"><a href="#breaking-changes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Breaking Changes</h2>
<p>Here’s a short list of breaking changes in this release:</p>
<ul>
<li>Node 6 is no longer supported.</li>
<li>Support for older browsers (such as IE 9 to IE 11) is now opt-in with a <a href="https://github.com/facebook/create-react-app/tree/master/packages/react-app-polyfill">separate package</a>.</li>
<li>Code-splitting with <code class="gatsby-code-text">import()</code> now behaves closer to specification, while <code class="gatsby-code-text">require.ensure()</code> is disabled.</li>
<li>The default Jest environment now includes jsdom.</li>
<li>Support for specifying an object as <code class="gatsby-code-text">proxy</code> setting was replaced with support for a custom proxy module.</li>
<li>Support for <code class="gatsby-code-text">.mjs</code> extension was removed until the ecosystem around it stabilizes.</li>
<li>PropTypes definitions are automatically stripped out of the production builds.</li>
</ul>
<p>If either of these points affects you, <a href="https://github.com/facebook/create-react-app/releases/tag/v2.0.3">2.0.3 release notes</a> contain more detailed instructions.</p>
<h2 id="learn-more"><a href="#learn-more" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Learn More</h2>
<p>You can find the full changelog in the <a href="https://github.com/facebook/create-react-app/releases/tag/v2.0.3">release notes</a>. This was a large release, and we may have missed something. Please report any problems to our <a href="https://github.com/facebook/create-react-app/issues/new">issue tracker</a> and we’ll try to help.</p>
<blockquote>
<p>Note</p>
<p>If you’ve been using 2.x alpha versions, we provide <a href="https://gist.github.com/gaearon/8650d1c70e436e5eff01f396dffc4114">separate migration instructions</a> for them.</p>
</blockquote>
<h2 id="thanks"><a href="#thanks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Thanks</h2>
<p>This release wouldn’t be possible without our wonderful community of contributors. We’d like to thank <a href="https://github.com/andriijas">Andreas Cederström</a>, <a href="https://github.com/clemmy">Clement Hoang</a>, <a href="https://github.com/existentialism">Brian Ng</a>, <a href="https://github.com/kentcdodds">Kent C. Dodds</a>, <a href="https://github.com/viankakrisna">Ade Viankakrisna Fadlil</a>, <a href="https://github.com/ai">Andrey Sitnik</a>, <a href="https://github.com/ro-savage">Ro Savage</a>, <a href="https://github.com/Fabianopb">Fabiano Brito</a>, <a href="https://github.com/iansu">Ian Sutherland</a>, <a href="https://github.com/petetnt">Pete Nykänen</a>, <a href="https://github.com/jeffposnick">Jeffrey Posnick</a>, <a href="https://github.com/bugzpodder">Jack Zhao</a>, <a href="https://github.com/sokra">Tobias Koppers</a>, <a href="https://github.com/hzoo">Henry Zhu</a>, <a href="https://github.com/arcanis">Maël Nison</a>, <a href="https://github.com/lixiaoyan">XiaoYan Li</a>, <a href="https://github.com/themre">Marko Trebizan</a>, <a href="https://github.com/mareksuscak">Marek Suscak</a>, <a href="https://github.com/miraage">Mikhail Osher</a>, and many others who provided feedback and testing for this release.</p>]]></description><link>https://reactjs.org/blog/2018/10/01/create-react-app-v2.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/10/01/create-react-app-v2.html</guid><pubDate>Mon, 01 Oct 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[Introducing the React Profiler]]></title><description><![CDATA[<p>React 16.5 adds support for a new DevTools profiler plugin.
This plugin uses React’s <a href="https://github.com/reactjs/rfcs/pull/51">experimental Profiler API</a> to collect timing information about each component that’s rendered in order to identify performance bottlenecks in React applications.
It will be fully compatible with our upcoming <a href="/reactdoc/blog/2018/03/01/sneak-peek-beyond-react-16.html">time slicing and suspense</a> features.</p>
<p>This blog post covers the following topics:</p>
<ul>
<li><a href="#profiling-an-application">Profiling an application</a></li>
<li>
<p><a href="#reading-performance-data">Reading performance data</a></p>
<ul>
<li><a href="#browsing-commits">Browsing commits</a></li>
<li><a href="#filtering-commits">Filtering commits</a></li>
<li><a href="#flame-chart">Flame chart</a></li>
<li><a href="#ranked-chart">Ranked chart</a></li>
<li><a href="#component-chart">Component chart</a></li>
<li><a href="#interactions">Interactions</a></li>
</ul>
</li>
<li>
<p><a href="#troubleshooting">Troubleshooting</a></p>
<ul>
<li><a href="#no-profiling-data-has-been-recorded-for-the-selected-root">No profiling data has been recorded for the selected root</a></li>
<li><a href="#no-timing-data-to-display-for-the-selected-commit">No timing data to display for the selected commit</a></li>
</ul>
</li>
<li><a href="#deep-dive-video">Deep dive video</a></li>
</ul>
<h2 id="profiling-an-application"><a href="#profiling-an-application" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Profiling an application</h2>
<p>DevTools will show a “Profiler” tab for applications that support the new profiling API:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/devtools-profiler-tab-4da6b55fc3c98de04c261cd902c14dc3-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB60lEQVQoz62RzW7TQBSFI8Srsekz1BJs2LDkLVjUKGSRxJay6AsgRJtCwwKJqiGNY4fSFhAqUdImkf/GcezxZHw9l5lpQXSBxIIjfTrjY+mTf2qDPXvr7XH34bA/2nbcsTEcjY0TxzMc95Px4ahvvN5/Y3QPDo2Xr/aMo+OB3r2xxPM0rutuSx45jvOgpvLty/l3uiaYXX7FTZYgcIqiLDSVPJcsQ9hkuquSyi1Hmq+RMaYpigJV5vO5q4W94dX5e2+F3YFfHowi6I1jeHeawKFHNL1xcof9YQRnPwgwmgOlFKSLK2GSJB+l7n5ttogvAp/hbBbA9TIRkzkT0yUVYVqKKKtEtIY7hJKsAIHid5QUCSEDLczW6YUa4utFFUwnOJkQvJqGSIIM+YYj54AbXsm+oSxBdonSqF/1D+GJFsZkpYWrZVKlYSyCgIo4osL3C7GKE5FEiTwzEYaFhIo0zgVnXIi/PWGepWdqSBeEp0EEflBAFDIIJSuyBimFwKdACINYkqUMoAQl+QW/Ffa18PNlOFFDSSvcyG+c5yj/ooQiMtmixH9KFEWnWrj12Hz67HnrhW1bO82WZbbbbbPVusFqt0zLkm3ZZlteq3uKZrNp1ut1s9FoKHZs2250Op0nWnibe/+B2u7ubu0n/Rxb5mrVIIgAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="New DevTools "profiler" tab"
        title=""
        src="/reactdoc/static/devtools-profiler-tab-4da6b55fc3c98de04c261cd902c14dc3-acf85.png"
        srcset="/reactdoc/static/devtools-profiler-tab-4da6b55fc3c98de04c261cd902c14dc3-c1418.png 210w,
/reactdoc/static/devtools-profiler-tab-4da6b55fc3c98de04c261cd902c14dc3-5d5d8.png 420w,
/reactdoc/static/devtools-profiler-tab-4da6b55fc3c98de04c261cd902c14dc3-acf85.png 840w,
/reactdoc/static/devtools-profiler-tab-4da6b55fc3c98de04c261cd902c14dc3-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<blockquote>
<p>Note:</p>
<p><code class="gatsby-code-text">react-dom</code> 16.5+ supports profiling in DEV mode.
A production profiling bundle is also available as <code class="gatsby-code-text">react-dom/profiling</code>.
Read more about how to use this bundle at <a href="https://fb.me/react-profiling">fb.me/react-profiling</a> </p>
</blockquote>
<p>The “Profiler” panel will be empty initially. Click the record button to start profiling:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/start-profiling-bae8d10e17f06eeb8c512c91c0153cff-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABdUlEQVQoz62QvU7DMBCAI8SrsfAMjQQzI+9RBthpq0ody9ABMTC0C0lKwo8KDEjt0GZomthJmx8S1+bukkbAiHrSp7OTu89na4+318f347sTe2w3DNPQDaPENE19OBzq/f6NPhgMIPf10WhE3+k/YBkPumPbDcdxTi3LOtIwPiYvnyxkaj53VRAEv/B9Xy2XS7VarZTnIR59Z4xBZsr1AsXDSGFMp1OHhLOn57cszZTP10Ucx+IvSZIQaZqK9XotNpuNkFKK7XYrCkSIHIVwuAG6Q40HwTsdoSQWSlwQ1fpngISoa0oEdnPOTRJGUURCrMdcFAUBI5RZCFX9rzMCYpWXtVQAz2CRMAzDWgjNEvaSeZ5ki4WEUyVcs55qNyWu8zyXcH2Jz1EJzZ1wUgnzLMtEAm+VcC5i1xVfsI+hAZqxqX47zNVVkbwSPpAQJpipPQQM9krCdrt93u12LzudThO4+AdN6L9qtVpnJKziYA9ovV5P+wavR2c66XZI3gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Click "record" to start profiling"
        title=""
        src="/reactdoc/static/start-profiling-bae8d10e17f06eeb8c512c91c0153cff-acf85.png"
        srcset="/reactdoc/static/start-profiling-bae8d10e17f06eeb8c512c91c0153cff-c1418.png 210w,
/reactdoc/static/start-profiling-bae8d10e17f06eeb8c512c91c0153cff-5d5d8.png 420w,
/reactdoc/static/start-profiling-bae8d10e17f06eeb8c512c91c0153cff-acf85.png 840w,
/reactdoc/static/start-profiling-bae8d10e17f06eeb8c512c91c0153cff-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Once you’ve started recording, DevTools will automatically collect performance information each time your application renders.
Use your app as you normally would.
When you are finished profiling, click the “Stop” button.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/stop-profiling-45619de03bed468869f7a0878f220586-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABcklEQVQoz62QS2vCQBCAQ+lf66W/wUB77rH/Qw/tuSQieLSHQMFDD3oxiSQHUfsCC1UP5rGJeTRuNrvd2SRiH/TkwMdkM7PfDiNZD3fnj+P+hTW2Grqhy7peYhiGPBgM5F7vXtY0jeeePBwOxX9R55j6SLYtq2Hb9qVpmmcSxNN08oZCxJbLNfN9/xue57HNZsNc12WOAzjiP0KIZ8TWjs+CcMsgFouFLYQfL6+zLNsxD0V5kiQkTRMCuSZN0z1wzrKM0KIgBScHCMEg5I/rXHcqhQjNxROMEnoQRUH/DC6i0HwAgdtBEBilcLsVQuitMiuo6GF8DPYzoC56eA3nOcvzXDTzNZilMAz3QpgAPlcrl2r9Z/qZJLQs/Z4QY0zjOKawikpo1MJpJcQcKJI03pHZ3CF8DELLVeyB3dV9FbgSjoQwiqJ3doTgg02EUFXV606nc9Nut5ucVo2iqK3D8z80+f1bRVGuhLCKkyMgdbtd6Qtm52eikNUIKgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Click "stop" when you are finished profiling"
        title=""
        src="/reactdoc/static/stop-profiling-45619de03bed468869f7a0878f220586-acf85.png"
        srcset="/reactdoc/static/stop-profiling-45619de03bed468869f7a0878f220586-c1418.png 210w,
/reactdoc/static/stop-profiling-45619de03bed468869f7a0878f220586-5d5d8.png 420w,
/reactdoc/static/stop-profiling-45619de03bed468869f7a0878f220586-acf85.png 840w,
/reactdoc/static/stop-profiling-45619de03bed468869f7a0878f220586-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Assuming your application rendered at least once while profiling, DevTools will show several ways to view the performance data.
We’ll <a href="#reading-performance-data">take a look at each of these below</a>.</p>
<h2 id="reading-performance-data"><a href="#reading-performance-data" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reading performance data</h2>
<h3 id="browsing-commits"><a href="#browsing-commits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Browsing commits</h3>
<p>Conceptually, React does work in two phases:</p>
<ul>
<li>The <strong>render</strong> phase determines what changes need to be made to e.g. the DOM. During this phase, React calls <code class="gatsby-code-text">render</code> and then compares the result to the previous render.</li>
<li>The <strong>commit</strong> phase is when React applies any changes. (In the case of React DOM, this is when React inserts, updates, and removes DOM nodes.) React also calls lifecycles like <code class="gatsby-code-text">componentDidMount</code> and <code class="gatsby-code-text">componentDidUpdate</code> during this phase.</li>
</ul>
<p>The DevTools profiler groups performance info by commit.
Commits are displayed in a bar chart near the top of the profiler:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/commit-selector-bd72dec045515d59be51c944e902d263-8ef72.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 601px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 9.983361064891847%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsSAAALEgHS3X78AAAAaklEQVQI103Kuw5AQBBAUf//LxqlQhQSjWqFQoIN2RkzY58iUVI63U1uBgDLqpFknLRBSSmFEOLPl4HZI95yRsSL6LHuZop0ZAfCuPnNsLWe5XTOfnP6MftOSnHfyzLXRT60pZ41qMp3zQsu+2w/rwWfxgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Bar chart of profiled commits"
        title=""
        src="/reactdoc/static/commit-selector-bd72dec045515d59be51c944e902d263-8ef72.png"
        srcset="/reactdoc/static/commit-selector-bd72dec045515d59be51c944e902d263-69e48.png 210w,
/reactdoc/static/commit-selector-bd72dec045515d59be51c944e902d263-3b0aa.png 420w,
/reactdoc/static/commit-selector-bd72dec045515d59be51c944e902d263-8ef72.png 601w"
        sizes="(max-width: 601px) 100vw, 601px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>Each bar in the chart represents a single commit with the currently selected commit colored black.
You can click on a bar (or the left/right arrow buttons) to select a different commit.</p>
<p>The color and height of each bar corresponds to how long that commit took to render.
(Taller, yellow bars took longer than shorter, blue bars.)</p>
<h3 id="filtering-commits"><a href="#filtering-commits" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Filtering commits</h3>
<p>The longer you profile, the more times your application will render.
In some cases you may end up with <em>too many commits</em> to easily process.
The profiler offers a filtering mechanism to help with this.
Use it to specify a threshold and the profiler will hide all commits that were <em>faster</em> than that value.</p>
<p><img src="/reactdoc/filtering-commits-683b9d860ef722e1505e5e629df7ef7e.gif" alt="Filtering commits by time"></p>
<h3 id="flame-chart"><a href="#flame-chart" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Flame chart</h3>
<p>The flame chart view represents the state of your application for a particular commit.
Each bar in the chart represents a React component (e.g. <code class="gatsby-code-text">App</code>, <code class="gatsby-code-text">Nav</code>).
The size and color of the bar represents how long it took to render the component and its children.
(The width of a bar represents how much time was spent <em>when the component last rendered</em> and the color represents how much time was spent <em>as part of the current commit</em>.)</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/flame-chart-3046f500b9bfc052bde8b7b3b3cfc243-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAAB30lEQVQoz62Rz08TURDHG+O/xsW/gZeIN6M3L548kTSQiFHUgx5oS9PIqQkhgaIpEovYbep2d1vaQgndSpV2f++2XWRnZ3y7LejZ8E2+eW/mzXzevN1EZevdvaKwfV/6Xpuv1UQWWRRFJksSE4Qy2y0U2F6xyHZ3CqwiVJmi1Jksy6yuKHGNJEnzPF7gPXOJSMftZsccTejXQCdvNCLf92NPJhNyXIdc1yXDMkk3dZ5zyfMcnvfIdhzyxmMeexRJVVUxBrbaJ0dD3SVdMwJDN8EyLG4TTO7hQAOeB7V3Bu2zDvwY9MHqdeGnUIGLahV8bQgBwFUE1DStzHF3E5/yyaaw+ZSOS0k4+rKIjVISGwfPsbG3iKeHy9j6uoQdeR3HZh/9y4CvJqp1Bd3zcwwsCzkLIqBt20IMXN1aaz7cWKZn2+/DtdIH2hA/0mE1T0tvH9Cb9ceU//yKbN+ha0EY0u8guIkRMQZallWJgQenJ82dwQWVhkbYG1+iz2vkfhdf7m/ifquMmqNHU2CIfzXl3OgaOJ1w5HqN2WX8W/BDXgBIANOnwHSoEKLGyP/uZ76aAb/FQP6XunQLchxHiYHpdPpJNptdzWQyK9wv/sMrvP91KpV6FANnunMLTuRyucQfU2RSA7PakTgAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Example flame chart"
        title=""
        src="/reactdoc/static/flame-chart-3046f500b9bfc052bde8b7b3b3cfc243-acf85.png"
        srcset="/reactdoc/static/flame-chart-3046f500b9bfc052bde8b7b3b3cfc243-c1418.png 210w,
/reactdoc/static/flame-chart-3046f500b9bfc052bde8b7b3b3cfc243-5d5d8.png 420w,
/reactdoc/static/flame-chart-3046f500b9bfc052bde8b7b3b3cfc243-acf85.png 840w,
/reactdoc/static/flame-chart-3046f500b9bfc052bde8b7b3b3cfc243-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<blockquote>
<p>Note:</p>
<p>The width of a bar indicates how long it took to render the component (and its children) when they last rendered.
If the component did not re-render as part of this commit, the time represents a previous render.
The wider a component is, the longer it took to render.</p>
<p>The color of a bar indicates how long the component (and its children) took to render in the selected commit.
Yellow components took more time, blue components took less time, and gray components did not render at all during this commit.</p>
</blockquote>
<p>For example, the commit shown above took a total of 18.4ms to render.
The <code class="gatsby-code-text">Router</code> component was the “most expensive” to render (taking 18.4ms).
Most of this time was due to two of its children, <code class="gatsby-code-text">Nav</code> (8.4ms) and <code class="gatsby-code-text">Route</code> (7.9ms).
The rest of the time was divided between its remaining children or spent in the component’s own render method.</p>
<p>You can zoom in or out on a flame chart by clicking on components:
<img src="/reactdoc/zoom-in-and-out-39ba82394205242af7c37ccb3a631f4d.gif" alt="Click on a component to zoom in or out"></p>
<p>Clicking on a component will also select it and show information in the right side panel which includes its <code class="gatsby-code-text">props</code> and <code class="gatsby-code-text">state</code> at the time of this commit.
You can drill into these to learn more about what the component actually rendered during the commit:</p>
<p><img src="/reactdoc/props-and-state-1f4d023f1a0f281386625f28df87c78f.gif" alt="Viewing a component&#x27;s props and state for a commit"></p>
<p>In some cases, selecting a component and stepping between commits may also provide a hint as to <em>why</em> the component rendered:</p>
<p><img src="/reactdoc/see-which-props-changed-cc2a8b37bbce52c49a11c2f8e55dccbc.gif" alt="Seeing which values changed between commits"></p>
<p>The above image shows that <code class="gatsby-code-text">state.scrollOffset</code> changed between commits.
This is likely what caused the <code class="gatsby-code-text">List</code> component to re-render.</p>
<h3 id="ranked-chart"><a href="#ranked-chart" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Ranked chart</h3>
<p>The ranked chart view represents a single commit.
Each bar in the chart represents a React component (e.g. <code class="gatsby-code-text">App</code>, <code class="gatsby-code-text">Nav</code>).
The chart is ordered so that the components which took the longest to render are at the top.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/ranked-chart-0c81347535e28c9cdef0e94fab887b89-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABlUlEQVQoz62OT2/TMBiHI7SvxoXPMEtwhhvckPYBECqHIY6s6r/BdpjaXmARNzSta6WQpGuF1o5kW7e1YYmj1HHiuH6xvYpNOwBC+0mPbL2v9fxsdFrvHpn7zceHVnfV/tZFtnWNa/dQr/MVmbufkWl+QeanNuod7CHXsZHjuqjf7yPHcZBt26vyfGJZ1kND5Xg0HpEcwLskkKQcSAa/wXMOEY4hTa4giCgkdAFzQiGOMUQRhiRJNCq+71taOOhtD04HHwCPWwU7aXF22ubFEuo1eXb8kQuvxmf9TU7HW3wefOeTixmfTac8yzJeFAVTwiAIOlK3Yrwovx4+a7yClJxzYKEQWSAg/3kDuxIiDwUUob6nSSg8zxdRFAkpE9LFlRBjfKCFL3fqw72Jr2YLtf0TKly+IoQApRQYYyCE0EJZ0NXCtWZ9eEawFsqIf8ntnlvC6x/aP44Oc7FQM6aWf0OW3p2xpXBfC/OUenAPiePY1cL3GxvPq9XqeqVSKUne/AelWq32tlwuP9XCZR7cA0aj0TB+AdiMX66/MIlxAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Example ranked chart"
        title=""
        src="/reactdoc/static/ranked-chart-0c81347535e28c9cdef0e94fab887b89-acf85.png"
        srcset="/reactdoc/static/ranked-chart-0c81347535e28c9cdef0e94fab887b89-c1418.png 210w,
/reactdoc/static/ranked-chart-0c81347535e28c9cdef0e94fab887b89-5d5d8.png 420w,
/reactdoc/static/ranked-chart-0c81347535e28c9cdef0e94fab887b89-acf85.png 840w,
/reactdoc/static/ranked-chart-0c81347535e28c9cdef0e94fab887b89-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<blockquote>
<p>Note:</p>
<p>A component’s render time includes the time spent rendering its children,
so the components which took the longest to render are generally near the top of the tree.</p>
</blockquote>
<p>As with the flame chart, you can zoom in or out on a ranked chart by clicking on components.</p>
<h3 id="component-chart"><a href="#component-chart" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Component chart</h3>
<p>Sometimes it’s useful to see how many times a particular component rendered while you were profiling.
The component chart provides this information in the form of a bar chart.
Each bar in the chart represents a time when the component rendered.
The color and height of each bar corresponds to how long the component took to render <em>relative to other components</em> in a particular commit.</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/component-chart-d71275b42c6109e222fbb0932a0c8c09-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAACSElEQVQoz62P20tUURTGh+gf6a33CHwTukCIQQ9JNw8kEZHRU2+9BzaCJ1LLB43xOPiaMjIgBl1Gzcuc0RnL0RQdTUWdOefsc3Wcs85ardlq9Af0wcf69tqL3147tjCeaPqiTzzM5xZbs9mscuJ5RWdPTU4qqVRKSafTyujIqJLJZBRd15WzuRzP5PP51kKh0JbL5a7H6lpZXloXrk27e/tkWhaZpkkWV0vYMpfLZVkNwyTTsEgIIV2f3auYZDsO1bW5WVqQwFJpa9lzHTosV0LX88D3ffC52lYFhLCAYbC/UwTXWOW8DfwY9wV4POP6Ac97NeGF9KO4Psu48zHnmIq00Ue1lV5AIqw7NJcwmH4sM0CEYRgihEfsABmEDMVqlc9RiCyob1gxjDkJrGwXipR/QrTWHdGZTJ0w00xQtfmAFNW8v1cRvxIeHpBrGVS2KuR6rgTaQsxLoFgdKdJCG1Vnn0bHYh0lwVlBmGjAo68tyE0Mph5hsPweg60xDJ0SVrd30d7ZQd8PMAKQQN76ZEN7bewnLbYTpC/Wqp+uwdGvBMBBBnDiMkSfGiCYeQ74uRFg/BKEqQsAvz9CzToGr7wPYSRhtVPgjAS6G+Ml2npJ9P0q0XwT0TTXmZtE2WaiuRucr5z09VucG4mcb0Q+f4S//K9s216SwMG+jhfJN+3dgx0tXVq8VR3qfKAOxe+o2ut77Luq1qmoWpxz/L6qddxWtb5Xav/bd2p/b4/6YWBAHdS0rmQy2ZNIJJ5J4KnO/QfHhoeHY38AsLpA6BTZFEwAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Example component chart"
        title=""
        src="/reactdoc/static/component-chart-d71275b42c6109e222fbb0932a0c8c09-acf85.png"
        srcset="/reactdoc/static/component-chart-d71275b42c6109e222fbb0932a0c8c09-c1418.png 210w,
/reactdoc/static/component-chart-d71275b42c6109e222fbb0932a0c8c09-5d5d8.png 420w,
/reactdoc/static/component-chart-d71275b42c6109e222fbb0932a0c8c09-acf85.png 840w,
/reactdoc/static/component-chart-d71275b42c6109e222fbb0932a0c8c09-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>The chart above shows that the <code class="gatsby-code-text">List</code> component rendered 11 times.
It also shows that each time it rendered, it was the most “expensive” component in the commit (meaning that it took the longest).</p>
<p>To view this chart, either double-click on a component <em>or</em> select a component and click on the blue bar chart icon in the right detail pane.
You can return to the previous chart by clicking the “x” button in the right detail pane.
You can aso double click on a particular bar to view more information about that commit.</p>
<p><img src="/reactdoc/see-all-commits-for-a-fiber-99cb4321ded8eb0c21ae5fc673878563.gif" alt="How to view all renders for a specific component"></p>
<p>If the selected component did not render at all during the profiling session, the following message will be shown:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/no-render-times-for-selected-component-8eb0c37a13353ef5d9e61ae8fc040705-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABZ0lEQVQoz62PzU7CQBDHG+OrefEZaKJnj74HHvQBCiHckQMx8eABE5VSUlDwQEI9oId+7PaD2rTLjrND26BHwz/5dbc7M/+Z0SZ3xumDdX9mT+yGaZp6xXg81ofDod7v9/XBYKD3erf4/0jvVY5ljnTbthvT6fTcsqwTTel9PlvyiMN6/QUBYxAEDBjbEQQBuK4Lvu+D53kE55xQuZ8egzCKQGm1ciZk6Dgf8zT9BtcPizhOxGazqUFTEUWRyPO8Bs2IJElETHlJzpMCXhfLZ7Q71jC4oBYghfrsU6m6qxMbSZxYZllWRreqTm3xQoZhGJLhFlUUBSiEEDXV286P8gAnpRjsOtEFBxv9MsSkLa4hFbiqZJxJjMk4jultX382IEOsqSd8KzvleAicQKRpSuBaKplQhQoVr+4leWn4RIY4gQMHEA42I8NWq3XZ6XSu2+12E7n6B02svzEM44IMSx0dAK3b7Wo/FtRnZY5UiRMAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="No render times for the selected component"
        title=""
        src="/reactdoc/static/no-render-times-for-selected-component-8eb0c37a13353ef5d9e61ae8fc040705-acf85.png"
        srcset="/reactdoc/static/no-render-times-for-selected-component-8eb0c37a13353ef5d9e61ae8fc040705-c1418.png 210w,
/reactdoc/static/no-render-times-for-selected-component-8eb0c37a13353ef5d9e61ae8fc040705-5d5d8.png 420w,
/reactdoc/static/no-render-times-for-selected-component-8eb0c37a13353ef5d9e61ae8fc040705-acf85.png 840w,
/reactdoc/static/no-render-times-for-selected-component-8eb0c37a13353ef5d9e61ae8fc040705-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h3 id="interactions"><a href="#interactions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Interactions</h3>
<p>React recently added another <a href="https://fb.me/react-interaction-tracing">experimental API</a> for tracing the <em>cause</em> of an update.
“Interactions” traced with this API will also be shown in the profiler:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/interactions-a91a39ac076b71aa7a202aaf46f8bd5a-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABl0lEQVQoz62RzW7aQBDHraqvlkufIZaSc499j/TQPgAgxD1wQJFy6IFKSQyOgBAUKVFJJKAW9trOrm28O97J7ILpoT1VGemn9Xz9Z0Z2bi8an36MLk/G/vh4OBy6NaPRyB0MBm6v13P7/b7bPe+S/9PGPc+zNf7Qcyfj8fFkMjn1ff/IMfYwv3tMeIrL1RrjOEZG1C9jDDebDYZheCBJEkzT1ObXYYzJ6ysaWywWt1bw19PTPY8TXP2OVMA45FkGWY0QIASHoiggJwT5JAo0BMIogpAxE5Naa1wul9ck99F5mU7nIgiwoMIKkXKVNkZDNchSy0zossh1JaWNZ9tCr4JAx4zpPM9MCMyGdNWNFXyezeZpFCEPgkpVgGVZopTygFIKt0LYb07nizRGUW6RtseSYmS1oGcF4/V6jqaxKCoFoEEpDeYljK+sX+182pLut9vX/LVhyvkMd1m5n/Zvdo1AdSSvQf9B7gWvrCDnfIHvYPTnp1aw2Wx+abfb31qt1hnx9T84o/7vjUbjsxXc24d3wOl0Os4blShlbz/d1/8AAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="The interactions panel"
        title=""
        src="/reactdoc/static/interactions-a91a39ac076b71aa7a202aaf46f8bd5a-acf85.png"
        srcset="/reactdoc/static/interactions-a91a39ac076b71aa7a202aaf46f8bd5a-c1418.png 210w,
/reactdoc/static/interactions-a91a39ac076b71aa7a202aaf46f8bd5a-5d5d8.png 420w,
/reactdoc/static/interactions-a91a39ac076b71aa7a202aaf46f8bd5a-acf85.png 840w,
/reactdoc/static/interactions-a91a39ac076b71aa7a202aaf46f8bd5a-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>The image above shows a profiling session that traced four interactions.
Each row represents an interaction that was traced.
The colored dots along the row represent commits that were related to that interaction.</p>
<p>You can also see which interactions were traced for a particular commit from the flame chart and ranked chart views as well:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/interactions-for-commit-9847e78f930cb7cf2b0f9682853a5dbc-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABuUlEQVQoz62Ry27aQBSGraqv1k2fISO16y77Humi3XUDCPECva3SICULLkkxYGKCsAmCFMYm2OBbYo7P6ZmBpllX+aVftmfO+fzPGaP97fPr0/aPN91f5pFpmkK50+mIbrcrms2GODn5Kc7PzsTXL99Fq9UW/X5f27Is0ev1VN0RP99yzytDaTS0x3dRSkt5R3GcUJZlj47jmDzPo9lsxt8xpWmq1zabDQVBQFEUaStNp9OOBlr29dV8uSYp5U56Hvi+r71arYBhwIUwHF6DlDNe8yAIQ/i9WIDHNdnDA+x2u1wBuafJuJdGvV637asBua4L4/EYlR3HRWswRNdx0HUnOJ/Pcb0OEAAwiSO8GY1wLSXmSYLMAgUMw7ClgXx2m+dBk8mk4DS8saEsjeiycUoXF5fkOA7luQ6hVdzfU3J7S9liQbnvExaFBvII2hrI87GTJFGzKbIs5X1CKlJMfROXS4k8N5UCH8Xv9MSsv8B9wu12Ozj8XMUAVcBdgPujwL+1vQtOhE+NmB+ADQ3kW7qhZxDffF8Dy+Xy+2q1+rFSqRyzP/yHj7n/U6lUeqeBB714Bhu1Ws34A880Xu+Ar3OjAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="List of interactions for a commit"
        title=""
        src="/reactdoc/static/interactions-for-commit-9847e78f930cb7cf2b0f9682853a5dbc-acf85.png"
        srcset="/reactdoc/static/interactions-for-commit-9847e78f930cb7cf2b0f9682853a5dbc-c1418.png 210w,
/reactdoc/static/interactions-for-commit-9847e78f930cb7cf2b0f9682853a5dbc-5d5d8.png 420w,
/reactdoc/static/interactions-for-commit-9847e78f930cb7cf2b0f9682853a5dbc-acf85.png 840w,
/reactdoc/static/interactions-for-commit-9847e78f930cb7cf2b0f9682853a5dbc-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>You can navigate between interactions and commits by clicking on them:</p>
<p><img src="/reactdoc/navigate-between-interactions-and-commits-7c66e7686b5242473c87b3d0b4576cf3.gif" alt="Navigate between interactions and commits"></p>
<p>The tracing API is still new and we will cover it in more detail in a future blog post.</p>
<h2 id="troubleshooting"><a href="#troubleshooting" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Troubleshooting</h2>
<h3 id="no-profiling-data-has-been-recorded-for-the-selected-root"><a href="#no-profiling-data-has-been-recorded-for-the-selected-root" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>No profiling data has been recorded for the selected root</h3>
<p>If your your application has multiple “roots”, you may see the following message after profiling:

  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/no-profiler-data-multi-root-0755492a211f5bbb775285c0ff2fdfda-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABjUlEQVQoz62Qy07CQBRAG+OvufEbmETXLv0PWOgH8GhY2wVCAjEuxbZUNEpMTCCB0kDoY0pfdKYz3hkeC40LE25yeqfzOHPnKtaDev74+ngxtIYlwzCQQNd11Ol0ULvdRpqmoftWC/V6PaTdaajb7SLTNOW+gaGjoWWVXoz+pTkwzxQRnwP9Cy8cbttz7vk+9zyP+5BXq5VkuVwexovFgruuywOxD3BcnwdBwHme8PFkbEnhZDT6yPyAu35Ioiimcbwl2ZMkh7xer2kURZQxRouioIQKaM4h4KI+6E6VIAxHfBsUYH8BHwYSyY81cU5U+iyFIcZSWGRZQaB8gvEvKMAJkbdCdRIQwxQRSCG0SZdCGEhhinERzGbMt20WAHg+Z6HjMG86ZWKeJAmD5x0qBBGD1rA0TffCbYXw9ndxU5KmebrZ0Ah6leW5RPzHcCDJMgrrsrciRA93TxXkO+GTFEKTJ/wIgTF+k8JarXbdaDRuIJfr9XoFckXkf1BWVfW2Wq1eSeEuTo6A0mw2lW+bPmTlyk2LHgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="No profiling data has been recorded for the selected root"
        title=""
        src="/reactdoc/static/no-profiler-data-multi-root-0755492a211f5bbb775285c0ff2fdfda-acf85.png"
        srcset="/reactdoc/static/no-profiler-data-multi-root-0755492a211f5bbb775285c0ff2fdfda-c1418.png 210w,
/reactdoc/static/no-profiler-data-multi-root-0755492a211f5bbb775285c0ff2fdfda-5d5d8.png 420w,
/reactdoc/static/no-profiler-data-multi-root-0755492a211f5bbb775285c0ff2fdfda-acf85.png 840w,
/reactdoc/static/no-profiler-data-multi-root-0755492a211f5bbb775285c0ff2fdfda-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<p>This message indicates that no performance data was recorded for the root that’s selected in the “Elements” panel.
In this case, try selecting a different root in that panel to view profiling information for that root:</p>
<p><img src="/reactdoc/select-a-root-to-view-profiling-data-bdc30593d414b5c8d2ae92027ed11940.gif" alt="Select a root in the &#x22;Elements&#x22; panel to view its performance data"></p>
<h3 id="no-timing-data-to-display-for-the-selected-commit"><a href="#no-timing-data-to-display-for-the-selected-commit" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>No timing data to display for the selected commit</h3>
<p>Sometimes a commit may be so fast that <code class="gatsby-code-text">performance.now()</code> doesn’t give DevTools any meaningful timing information.
In this case, the following message will be shown:</p>
<p>
  <a
    class="gatsby-resp-image-link"
    href="/reactdoc/static/no-timing-data-for-commit-63b2fb6298feecb179272c467020ed95-53c76.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
  
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 47.82608695652174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsSAAALEgHS3X78AAABe0lEQVQoz61QTUvDQBAN4l/z4m9oQM8e/R/1oFehLaU/QSwWexK0CYQkrQURNGAxkKRJNh/tJpNdZzdJqSdB+uAxs7Ozb96Oot/dnj7q47OFaXZMy1RNs6Zt26quzdSHyVSdTJ/U8f1Y1TRd1i3LUufzuYzY28F4bhjGiSLwtrTfw4Twjy+PJ4TwLMt2jCLCw+Cbp4HD1+EaaylPkoTHcYx3kcwFBRzHMaSg7/uvDAtxRsuCUiiKAsqyhBLjZrMFmsdAExfCyAcoKaRpCqvVClzXxfuN6C2EoOd5Lyh3rBBClrwGINlfzPOcoRuGLllVVax5JxzPfgniFytsrr+bZ1zkguiIp/it7XZbTwXglFLegjEmBcMw1KRgEARLLHIUrkhCGJ4ZrmFHbGS4J0kc1rpie2gFa4doddFMLpCA0+Vu0J2MYqcoAi1ELkT2WDSCz1IQJ3/yAwB3akvBfr9/ORwOrweDQRd59Q928f1Nr9e7kIINjg5AZTQaKT+0smf7vT5VvwAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="No timing data to display for the selected commit"
        title=""
        src="/reactdoc/static/no-timing-data-for-commit-63b2fb6298feecb179272c467020ed95-acf85.png"
        srcset="/reactdoc/static/no-timing-data-for-commit-63b2fb6298feecb179272c467020ed95-c1418.png 210w,
/reactdoc/static/no-timing-data-for-commit-63b2fb6298feecb179272c467020ed95-5d5d8.png 420w,
/reactdoc/static/no-timing-data-for-commit-63b2fb6298feecb179272c467020ed95-acf85.png 840w,
/reactdoc/static/no-timing-data-for-commit-63b2fb6298feecb179272c467020ed95-53c76.png 1012w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  
  </a>
    </p>
<h2 id="deep-dive-video"><a href="#deep-dive-video" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deep dive video</h2>
<p>The following video demonstrates how the React profiler can be used to detect and improve performance bottlenecks in an actual React application.</p>
<br>
<div>
          <div
            class="gatsby-resp-iframe-wrapper"
            style="padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden;"
          >
            <iframe src="https://www.youtube-nocookie.com/embed/nySib7ipZdk?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
          "></iframe>
          </div>
          </div>]]></description><link>https://reactjs.org/blog/2018/09/10/introducing-the-react-profiler.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/09/10/introducing-the-react-profiler.html</guid><pubDate>Mon, 10 Sep 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[React v16.4.2: Server-side vulnerability fix]]></title><description><![CDATA[<p>We discovered a minor vulnerability that might affect some apps using ReactDOMServer. We are releasing a patch version for every affected React minor release so that you can upgrade with no friction. Read on for more details.</p>
<h2 id="short-description"><a href="#short-description" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Short Description</h2>
<p>Today, we are releasing a fix for a vulnerability we discovered in the <code class="gatsby-code-text">react-dom/server</code> implementation. It was introduced with the version 16.0.0 and has existed in all subsequent releases until today.</p>
<p>This vulnerability <strong>can only affect some server-rendered React apps.</strong> Purely client-rendered apps are <strong>not</strong> affected. Additionally, we expect that most server-rendered apps don’t contain the vulnerable pattern described below. Nevertheless, we recommend to follow the mitigation instructions at the earliest opportunity.</p>
<p>While we were investigating this vulnerability, we found similar vulnerabilities in a few other popular front-end libraries. We have coordinated this release together with <a href="https://github.com/vuejs/vue/releases/tag/v2.5.17">Vue</a> and <a href="https://github.com/developit/preact-render-to-string/releases/tag/3.7.1">Preact</a> releases fixing the same issue. The tracking number for this vulnerability is <code class="gatsby-code-text">CVE-2018-6341</code>.</p>
<h2 id="mitigation"><a href="#mitigation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mitigation</h2>
<p><strong>We have prepared a patch release with a fix for every affected minor version.</strong></p>
<h3 id="160x"><a href="#160x" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>16.0.x</h3>
<p>If you’re using <code class="gatsby-code-text">react-dom/server</code> with this version:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.0.0</code></li>
</ul>
<p>Update to this version instead:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.0.1</code> <strong>(contains the mitigation)</strong></li>
</ul>
<h3 id="161x"><a href="#161x" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>16.1.x</h3>
<p>If you’re using <code class="gatsby-code-text">react-dom/server</code> with one of these versions:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.1.0</code></li>
<li><code class="gatsby-code-text">react-dom@16.1.1</code></li>
</ul>
<p>Update to this version instead:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.1.2</code> <strong>(contains the mitigation)</strong></li>
</ul>
<h3 id="162x"><a href="#162x" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>16.2.x</h3>
<p>If you’re using <code class="gatsby-code-text">react-dom/server</code> with this version:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.2.0</code></li>
</ul>
<p>Update to this version instead:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.2.1</code> <strong>(contains the mitigation)</strong></li>
</ul>
<h3 id="163x"><a href="#163x" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>16.3.x</h3>
<p>If you’re using <code class="gatsby-code-text">react-dom/server</code> with one of these versions:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.3.0</code></li>
<li><code class="gatsby-code-text">react-dom@16.3.1</code></li>
<li><code class="gatsby-code-text">react-dom@16.3.2</code></li>
</ul>
<p>Update to this version instead:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.3.3</code> <strong>(contains the mitigation)</strong></li>
</ul>
<h3 id="164x"><a href="#164x" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>16.4.x</h3>
<p>If you’re using <code class="gatsby-code-text">react-dom/server</code> with one of these versions:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.4.0</code></li>
<li><code class="gatsby-code-text">react-dom@16.4.1</code></li>
</ul>
<p>Update to this version instead:</p>
<ul>
<li><code class="gatsby-code-text">react-dom@16.4.2</code> <strong>(contains the mitigation)</strong></li>
</ul>
<p>If you’re using a newer version of <code class="gatsby-code-text">react-dom</code>, no action is required.</p>
<p>Note that only the <code class="gatsby-code-text">react-dom</code> package needs to be updated.</p>
<h2 id="detailed-description"><a href="#detailed-description" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Detailed Description</h2>
<p>Your app might be affected by this vulnerability only if both of these two conditions are true:</p>
<ul>
<li>Your app is <strong>being rendered to HTML using <a href="/reactdoc/docs/react-dom-server.html">ReactDOMServer API</a></strong>, and</li>
<li>Your app <strong>includes a user-supplied attribute name in an HTML tag.</strong></li>
</ul>
<p>Specifically, the vulnerable pattern looks like this:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">let</span> props <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line">props<span class="token punctuation">[</span>userProvidedData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
</span><span class="token keyword">let</span> element <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token keyword">let</span> html <span class="token operator">=</span> ReactDOMServer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>In order to exploit it, the attacker would need to craft a special attribute name that triggers an <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> vulnerability. For example:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">let</span> userProvidedData <span class="token operator">=</span> <span class="token string">'>&lt;/div>&lt;script>alert("hi")&lt;/script>'</span><span class="token punctuation">;</span></code></pre></div>
<p>In the vulnerable versions of <code class="gatsby-code-text">react-dom/server</code>, the output would let the attacker inject arbitrary markup:</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript"><span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"hi"</span><span class="token punctuation">)</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>In the versions after the vulnerability was <a href="https://github.com/facebook/react/pull/13302">fixed</a> (and before it was introduced), attributes with invalid names are skipped:</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span></code></pre></div>
<p>You would also see a warning about an invalid attribute name.</p>
<p>Note that <strong>we expect attribute names based on user input to be very rare in practice.</strong> It doesn’t serve any common practical use case, and has other potential security implications that React can’t guard against.</p>
<h2 id="installation"><a href="#installation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation</h2>
<p>React v16.4.2 is available on the npm registry.</p>
<p>To install React 16 with Yarn, run:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash">yarn add react@^16.4.2 react-dom@^16.4.2</code></pre></div>
<p>To install React 16 with npm, run:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">npm</span> <span class="token function">install</span> --save react@^16.4.2 react-dom@^16.4.2</code></pre></div>
<p>We also provide UMD builds of React via a CDN:</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react@16/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@16/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>Refer to the documentation for <a href="/reactdoc/docs/installation.html">detailed installation instructions</a>.</p>
<h2 id="changelog"><a href="#changelog" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changelog</h2>
<h3 id="react-dom-server"><a href="#react-dom-server" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM Server</h3>
<ul>
<li>
<p>Fix a potential XSS vulnerability when the attacker controls an attribute name (<code class="gatsby-code-text">CVE-2018-6341</code>). This fix is available in the latest <code class="gatsby-code-text">react-dom@16.4.2</code>, as well as in previous affected minor versions: <code class="gatsby-code-text">react-dom@16.0.1</code>, <code class="gatsby-code-text">react-dom@16.1.2</code>, <code class="gatsby-code-text">react-dom@16.2.1</code>, and <code class="gatsby-code-text">react-dom@16.3.3</code>. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/13302">#13302</a>)</p>
</li>
<li>
<p>Fix a crash in the server renderer when an attribute is called <code class="gatsby-code-text">hasOwnProperty</code>. This fix is only available in <code class="gatsby-code-text">react-dom@16.4.2</code>. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/13303">#13303</a>)</p>
</li>
</ul>]]></description><link>https://reactjs.org/blog/2018/08/01/react-v-16-4-2.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/08/01/react-v-16-4-2.html</guid><pubDate>Wed, 01 Aug 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[You Probably Don't Need Derived State]]></title><description><![CDATA[<p>React 16.4 included a <a href="/reactdoc/blog/2018/05/23/react-v-16-4.html#bugfix-for-getderivedstatefromprops">bugfix for getDerivedStateFromProps</a> which caused some existing bugs in React components to reproduce more consistently. If this release exposed a case where your application was using an anti-pattern and didn’t work properly after the fix, we’re sorry for the churn. In this post, we will explain some common anti-patterns with derived state and our preferred alternatives.</p>
<p>For a long time, the lifecycle <code class="gatsby-code-text">componentWillReceiveProps</code> was the only way to update state in response to a change in props without an additional render. In version 16.3, <a href="/reactdoc/blog/2018/03/29/react-v-16-3.html#component-lifecycle-changes">we introduced a replacement lifecycle, <code class="gatsby-code-text">getDerivedStateFromProps</code></a> to solve the same use cases in a safer way. At the same time, we’ve realized that people have many misconceptions about how to use both methods, and we’ve found anti-patterns that result in subtle and confusing bugs. The <code class="gatsby-code-text">getDerivedStateFromProps</code> bugfix in 16.4 <a href="https://github.com/facebook/react/issues/12898">makes derived state more predictable</a>, so the results of misusing it are easier to notice.</p>
<blockquote>
<p>Note</p>
<p>All of the anti-patterns described in this post apply to both the older <code class="gatsby-code-text">componentWillReceiveProps</code> and the newer <code class="gatsby-code-text">getDerivedStateFromProps</code>.</p>
</blockquote>
<p> This blog post will cover the following topics:</p>
<ul>
<li><a href="#when-to-use-derived-state">When to use derived state</a></li>
<li>
<p><a href="#common-bugs-when-using-derived-state">Common bugs when using derived state</a></p>
<ul>
<li><a href="#anti-pattern-unconditionally-copying-props-to-state">Anti-pattern: Unconditionally copying props to state</a></li>
<li><a href="#anti-pattern-erasing-state-when-props-change">Anti-pattern: Erasing state when props change</a></li>
</ul>
</li>
<li><a href="#preferred-solutions">Preferred solutions</a></li>
<li><a href="#what-about-memoization">What about memoization?</a></li>
</ul>
<h2 id="when-to-use-derived-state"><a href="#when-to-use-derived-state" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>When to Use Derived State</h2>
<p><code class="gatsby-code-text">getDerivedStateFromProps</code> exists for only one purpose. It enables a component to update its internal state as the result of <strong>changes in props</strong>. Our previous blog post provided some examples, like <a href="/reactdoc/blog/2018/03/27/update-on-async-rendering.html#updating-state-based-on-props">recording the current scroll direction based on a changing offset prop</a> or <a href="/reactdoc/blog/2018/03/27/update-on-async-rendering.html#fetching-external-data-when-props-change">loading external data specified by a source prop</a>.</p>
<p>We did not provide many examples, because as a general rule, <strong>derived state should be used sparingly</strong>. All problems with derived state that we have seen can be ultimately reduced to either (1) unconditionally updating state from props or (2) updating state whenever props and state don’t match. (We’ll go over both in more detail below.)</p>
<ul>
<li>If you’re using derived state to memoize some computation based only on the current props, you don’t need derived state. See <a href="#what-about-memoization">What about memoization?</a> below.</li>
<li>If you’re updating derived state unconditionally or updating it whenever props and state don’t match, your component likely resets its state too frequently. Read on for more details.</li>
</ul>
<h2 id="common-bugs-when-using-derived-state"><a href="#common-bugs-when-using-derived-state" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Common Bugs When Using Derived State</h2>
<p>The terms <a href="/reactdoc/docs/forms.html#controlled-components">“controlled”</a> and <a href="/reactdoc/docs/uncontrolled-components.html">“uncontrolled”</a> usually refer to form inputs, but they can also describe where any component’s data lives. Data passed in as props can be thought of as <strong>controlled</strong> (because the parent component <em>controls</em> that data). Data that exists only in internal state can be thought of as <strong>uncontrolled</strong> (because the parent can’t directly change it).</p>
<p>The most common mistake with derived state is mixing these two; when a derived state value is also updated by <code class="gatsby-code-text">setState</code> calls, there isn’t a single source of truth for the data. The <a href="/reactdoc/blog/2018/03/27/update-on-async-rendering.html#fetching-external-data-when-props-change">external data loading example</a> mentioned above may sound similar, but it’s different in a few important ways. In the loading example, there is a clear source of truth for both the “source” prop and the “loading” state. When the source prop changes, the loading state should <strong>always</strong> be overridden. Conversely, the state is overridden only when the prop <strong>changes</strong> and is otherwise managed by the component.</p>
<p>Problems arise when any of these constraints are changed. This typically comes in two forms. Let’s take a look at both.</p>
<h3 id="anti-pattern-unconditionally-copying-props-to-state"><a href="#anti-pattern-unconditionally-copying-props-to-state" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Anti-pattern: Unconditionally copying props to state</h3>
<p>A common misconception is that <code class="gatsby-code-text">getDerivedStateFromProps</code> and <code class="gatsby-code-text">componentWillReceiveProps</code> are only called when props “change”. These lifecycles are called any time a parent component rerenders, regardless of whether the props are “different” from before. Because of this, it has always been unsafe to <em>unconditionally</em> override state using either of these lifecycles. <strong>Doing so will cause state updates to be lost.</strong></p>
<p>Let’s consider an example to demonstrate the problem. Here is a <code class="gatsby-code-text">EmailInput</code> component that “mirrors” an email prop in state:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>email<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This will erase any local state updates!</span>
    <span class="token comment">// Do not do this.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> nextProps<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>At first, this component might look okay. State is initialized to the value specified by props and updated when we type into the <code class="gatsby-code-text">&lt;input&gt;</code>. But if our component’s parent rerenders, anything we’ve typed into the <code class="gatsby-code-text">&lt;input&gt;</code> will be lost! (<a href="https://codesandbox.io/s/m3w9zn1z8x">See this demo for an example.</a>) This holds true even if we were to compare <code class="gatsby-code-text">nextProps.email !== this.state.email</code> before resetting.</p>
<p>In this simple example, adding <code class="gatsby-code-text">shouldComponentUpdate</code> to rerender only when the email prop has changed could fix this. However in practice, components usually accept multiple props; another prop changing would still cause a rerender and improper reset. Function and object props are also often created inline, making it hard to implement a <code class="gatsby-code-text">shouldComponentUpdate</code> that reliably returns true only when a material change has happened. <a href="https://codesandbox.io/s/jl0w6r9w59">Here is a demo that shows that happening.</a> As a result, <code class="gatsby-code-text">shouldComponentUpdate</code> is best used as a performance optimization, not to ensure correctness of derived state.</p>
<p>Hopefully it’s clear by now why <strong>it is a bad idea to unconditionally copy props to state</strong>. Before reviewing possible solutions, let’s look at a related problematic pattern: what if we were to only update the state when the email prop changes?</p>
<h3 id="anti-pattern-erasing-state-when-props-change"><a href="#anti-pattern-erasing-state-when-props-change" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Anti-pattern: Erasing state when props change</h3>
<p>Continuing the example above, we could avoid accidentally erasing state by only updating it when <code class="gatsby-code-text">props.email</code> changes:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    email<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>email
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Any time props.email changes, update state.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>email <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        email<span class="token punctuation">:</span> nextProps<span class="token punctuation">.</span>email
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<blockquote>
<p>Note</p>
<p>Even though the example above shows <code class="gatsby-code-text">componentWillReceiveProps</code>, the same anti-pattern applies to <code class="gatsby-code-text">getDerivedStateFromProps</code>.</p>
</blockquote>
<p>We’ve just made a big improvement. Now our component will erase what we’ve typed only when the props actually change.</p>
<p>There is still a subtle problem. Imagine a password manager app using the above input component. When navigating between details for two accounts with the same email, the input would fail to reset. This is because the prop value passed to the component would be the same for both accounts! This would be a surprise to the user, as an unsaved change to one account would appear to affect other accounts that happened to share the same email. (<a href="https://codesandbox.io/s/mz2lnkjkrx">See demo here.</a>)</p>
<p>This design is fundamentally flawed, but it’s also an easy mistake to make. (<a href="https://twitter.com/brian_d_vaughn/status/959600888242307072">I’ve made it myself!</a>) Fortunately there are two alternatives that work better. The key to both is that <strong>for any piece of data, you need to pick a single component that owns it as the source of truth, and avoid duplicating it in other components.</strong> Let’s take a look at each of the alternatives.</p>
<h2 id="preferred-solutions"><a href="#preferred-solutions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preferred Solutions</h2>
<h3 id="recommendation-fully-controlled-component"><a href="#recommendation-fully-controlled-component" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Recommendation: Fully controlled component</h3>
<p>One way to avoid the problems mentioned above is to remove state from our component entirely. If the email address only exists as a prop, then we don’t have to worry about conflicts with state. We could even convert <code class="gatsby-code-text">EmailInput</code> to a lighter-weight function component:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">function</span> <span class="token function">EmailInput</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>onChange<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>email<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This approach simplifies the implementation of our component, but if we still want to store a draft value, the parent form component will now need to do that manually. (<a href="https://codesandbox.io/s/7154w1l551">Click here to see a demo of this pattern.</a>)</p>
<h3 id="recommendation-fully-uncontrolled-component-with-a-key"><a href="#recommendation-fully-uncontrolled-component-with-a-key" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Recommendation: Fully uncontrolled component with a <code class="gatsby-code-text">key</code></h3>
<p>Another alternative would be for our component to fully own the “draft” email state. In that case, our component could still accept a prop for the <em>initial</em> value, but it would ignore subsequent changes to that prop:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> email<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>defaultEmail <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>email<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In order to reset the value when moving to a different item (as in our password manager scenario), we can use the special React attribute called <code class="gatsby-code-text">key</code>. When a <code class="gatsby-code-text">key</code> changes, React will <a href="/reactdoc/docs/reconciliation.html#keys"><em>create</em> a new component instance rather than <em>update</em> the current one</a>. Keys are usually used for dynamic lists but are also useful here. In our case, we could use the user ID to recreate the email input any time a new user is selected:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>EmailInput</span>
  <span class="token attr-name">defaultEmail</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>email<span class="token punctuation">}</span></span>
  <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span>
<span class="token punctuation">/></span></span></code></pre></div>
<p>Each time the ID changes, the <code class="gatsby-code-text">EmailInput</code> will be recreated and its state will be reset to the latest <code class="gatsby-code-text">defaultEmail</code> value. (<a href="https://codesandbox.io/s/6v1znlxyxn">Click here to see a demo of this pattern.</a>) With this approach, you don’t have to add <code class="gatsby-code-text">key</code> to every input. It might make more sense to put a <code class="gatsby-code-text">key</code> on the whole form instead. Every time the key changes, all components within the form will be recreated with a freshly initialized state.</p>
<p>In most cases, this is the best way to handle state that needs to be reset.</p>
<blockquote>
<p>Note</p>
<p>While this may sound slow, the performance difference is usually insignificant. Using a key can even be faster if the components have heavy logic that runs on updates since diffing gets bypassed for that subtree.</p>
</blockquote>
<h4 id="alternative-1-reset-uncontrolled-component-with-an-id-prop"><a href="#alternative-1-reset-uncontrolled-component-with-an-id-prop" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Alternative 1: Reset uncontrolled component with an ID prop</h4>
<p>If <code class="gatsby-code-text">key</code> doesn’t work for some reason (perhaps the component is very expensive to initialize), a workable but cumbersome solution would be to watch for changes to “userID” in <code class="gatsby-code-text">getDerivedStateFromProps</code>:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    email<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>defaultEmail<span class="token punctuation">,</span>
    prevPropsUserID<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Any time the current user changes,</span>
    <span class="token comment">// Reset any parts of state that are tied to that user.</span>
    <span class="token comment">// In this simple example, that's just the email.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>userID <span class="token operator">!==</span> state<span class="token punctuation">.</span>prevPropsUserID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        prevPropsUserID<span class="token punctuation">:</span> props<span class="token punctuation">.</span>userID<span class="token punctuation">,</span>
        email<span class="token punctuation">:</span> props<span class="token punctuation">.</span>defaultEmail
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This also provides the flexibility to only reset parts of our component’s internal state if we so choose. (<a href="https://codesandbox.io/s/rjyvp7l3rq">Click here to see a demo of this pattern.</a>)</p>
<blockquote>
<p>Note</p>
<p>Even though the example above shows <code class="gatsby-code-text">getDerivedStateFromProps</code>, the same technique can be used with <code class="gatsby-code-text">componentWillReceiveProps</code>.</p>
</blockquote>
<h4 id="alternative-2-reset-uncontrolled-component-with-an-instance-method"><a href="#alternative-2-reset-uncontrolled-component-with-an-instance-method" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Alternative 2: Reset uncontrolled component with an instance method</h4>
<p>More rarely, you may need to reset state even if there’s no appropriate ID to use as <code class="gatsby-code-text">key</code>. One solution is to reset the key to a random value or autoincrementing number each time you want to reset. One other viable alternative is to expose an instance method to imperatively reset the internal state:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">EmailInput</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    email<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>defaultEmail
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">resetEmailForNewUser</span><span class="token punctuation">(</span>newEmail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> newEmail <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The parent form component could then <a href="/reactdoc/docs/glossary.html#refs">use a <code class="gatsby-code-text">ref</code> to call this method</a>. (<a href="https://codesandbox.io/s/l70krvpykl">Click here to see a demo of this pattern.</a>)</p>
<p>Refs can be useful in certain cases like this one, but generally we recommend you use them sparingly. Even in the demo, this imperative method is nonideal because two renders will occur instead of one.</p>
<hr>
<h3 id="recap"><a href="#recap" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Recap</h3>
<p>To recap, when designing a component, it is important to decide whether its data will be controlled or uncontrolled.</p>
<p>Instead of trying to <strong>“mirror” a prop value in state</strong>, make the component <strong>controlled</strong>, and consolidate the two diverging values in the state of some parent component. For example, rather than a child accepting a “committed” <code class="gatsby-code-text">props.value</code> and tracking a “draft” <code class="gatsby-code-text">state.value</code>, have the parent manage both <code class="gatsby-code-text">state.draftValue</code> and <code class="gatsby-code-text">state.committedValue</code> and control the child’s value directly. This makes the data flow more explicit and predictable.</p>
<p>For <strong>uncontrolled</strong> components, if you’re trying to reset state when a particular prop (usually an ID) changes, you have a few options:</p>
<ul>
<li><strong>Recomendation: To reset <em>all internal state</em>, use the <code class="gatsby-code-text">key</code> attribute.</strong></li>
<li>Alternative 1: To reset <em>only certain state fields</em>, watch for changes in a special property (e.g. <code class="gatsby-code-text">props.userID</code>).</li>
<li>Alternative 2: You can also consider fall back to an imperative instance method using refs.</li>
</ul>
<h2 id="what-about-memoization"><a href="#what-about-memoization" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What about memoization?</h2>
<p>We’ve also seen derived state used to ensure an expensive value used in <code class="gatsby-code-text">render</code> is recomputed only when the inputs change. This technique is known as <a href="https://en.wikipedia.org/wiki/Memoization">memoization</a>.</p>
<p>Using derived state for memoization isn’t necessarily bad, but it’s usually not the best solution. There is inherent complexity in managing derived state, and this complexity increases with each additional property. For example, if we add a second derived field to our component state then our implementation would need to separately track changes to both.</p>
<p>Let’s look at an example of one component that takes one prop—a list of items—and renders the items that match a search query entered by the user. We could use derived state to store the filtered list:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    filterText<span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// *******************************************************</span>
  <span class="token comment">// NOTE: this example is NOT the recommended approach.</span>
  <span class="token comment">// See the examples below for our recommendations instead.</span>
  <span class="token comment">// *******************************************************</span>

  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Re-run the filter whenever the list array or filter text change.</span>
    <span class="token comment">// Note we need to store prevPropsList and prevFilterText to detect changes.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      props<span class="token punctuation">.</span>list <span class="token operator">!==</span> state<span class="token punctuation">.</span>prevPropsList <span class="token operator">||</span>
      state<span class="token punctuation">.</span>prevFilterText <span class="token operator">!==</span> state<span class="token punctuation">.</span>filterText
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        prevPropsList<span class="token punctuation">:</span> props<span class="token punctuation">.</span>list<span class="token punctuation">,</span>
        prevFilterText<span class="token punctuation">:</span> state<span class="token punctuation">.</span>filterText<span class="token punctuation">,</span>
        filteredList<span class="token punctuation">:</span> props<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">=></span> item<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>filterText<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filterText<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fragment</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>filterText<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>filteredList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Fragment</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This implementation avoids recalculating <code class="gatsby-code-text">filteredList</code> more often than necessary. But it is more complicated than it needs to be, because it has to separately track and detect changes in both props and state in order to properly update the filtered list. In this example, we could simplify things by using <code class="gatsby-code-text">PureComponent</code> and moving the filter operation into the render method: </p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token comment">// PureComponents only rerender if at least one state or prop value changes.</span>
<span class="token comment">// Change is determined by doing a shallow comparison of state and prop keys.</span>
<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{</span>
  <span class="token comment">// State only needs to hold the current filter text value:</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    filterText<span class="token punctuation">:</span> <span class="token string">""</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filterText<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// The render method on this PureComponent is called only if</span>
    <span class="token comment">// props.list or state.filterText has changed.</span>
    <span class="token keyword">const</span> filteredList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
      item <span class="token operator">=></span> item<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>filterText<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fragment</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>filterText<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>filteredList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Fragment</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The above approach is much cleaner and simpler than the derived state version. Occasionally, this won’t be good enough—filtering may be slow for large lists, and <code class="gatsby-code-text">PureComponent</code> won’t prevent rerenders if another prop were to change. To address both of these concerns, we could add a memoization helper to avoid unnecessarily re-filtering our list:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">import</span> memoize <span class="token keyword">from</span> <span class="token string">"memoize-one"</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// State only needs to hold the current filter text value:</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span> filterText<span class="token punctuation">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Re-run the filter whenever the list array or filter text changes:</span>
  filter <span class="token operator">=</span> <span class="token function">memoize</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>list<span class="token punctuation">,</span> filterText<span class="token punctuation">)</span> <span class="token operator">=></span> list<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>item <span class="token operator">=></span> item<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>filterText<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function-variable function">handleChange</span> <span class="token operator">=</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filterText<span class="token punctuation">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Calculate the latest filtered list. If these arguments haven't changed</span>
    <span class="token comment">// since the last render, `memoize-one` will reuse the last return value.</span>
    <span class="token keyword">const</span> filteredList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>filterText<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Fragment</span><span class="token punctuation">></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">onChange</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleChange<span class="token punctuation">}</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>filterText<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>filteredList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>item <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Fragment</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This is much simpler and performs just as well as the derived state version!</p>
<p>When using memoization, remember a couple of constraints:</p>
<ol>
<li>In most cases, you’ll want to <strong>attach the memoized function to a component instance</strong>. This prevents multiple instances of a component from resetting each other’s memoized keys.</li>
<li>Typically you’ll want to use a memoization helper with a <strong>limited cache size</strong> in order to prevent memory leaks over time. (In the example above, we used <code class="gatsby-code-text">memoize-one</code> because it only caches the most recent arguments and result.)</li>
<li>None of the implementations shown in this section will work if <code class="gatsby-code-text">props.list</code> is recreated each time the parent component renders. But in most cases, this setup is appropriate.</li>
</ol>
<h2 id="in-closing"><a href="#in-closing" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>In closing</h2>
<p>In real world applications, components often contain a mix of controlled and uncontrolled behaviors. This is okay! If each value has a clear source of truth, you can avoid the anti-patterns mentioned above.</p>
<p>It is also worth re-iterating that <code class="gatsby-code-text">getDerivedStateFromProps</code> (and derived state in general) is an advanced feature and should be used sparingly because of this complexity. If your use case falls outside of these patterns, please share it with us on <a href="https://github.com/reactjs/reactjs.org/issues/new">GitHub</a> or <a href="https://twitter.com/reactjs">Twitter</a>!</p>]]></description><link>https://reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/06/07/you-probably-dont-need-derived-state.html</guid><pubDate>Thu, 07 Jun 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[React v16.4.0: Pointer Events]]></title><description><![CDATA[<p>The latest minor release adds support for an oft-requested feature: pointer events!</p>
<p>It also includes a bugfix for <code class="gatsby-code-text">getDerivedStateFromProps</code>. Check out the full <a href="#changelog">changelog</a> below.</p>
<h2 id="pointer-events"><a href="#pointer-events" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Pointer Events</h2>
<p>The following event types are now available in React DOM:</p>
<ul>
<li><code class="gatsby-code-text">onPointerDown</code></li>
<li><code class="gatsby-code-text">onPointerMove</code></li>
<li><code class="gatsby-code-text">onPointerUp</code></li>
<li><code class="gatsby-code-text">onPointerCancel</code></li>
<li><code class="gatsby-code-text">onGotPointerCapture</code></li>
<li><code class="gatsby-code-text">onLostPointerCapture</code></li>
<li><code class="gatsby-code-text">onPointerEnter</code></li>
<li><code class="gatsby-code-text">onPointerLeave</code></li>
<li><code class="gatsby-code-text">onPointerOver</code></li>
<li><code class="gatsby-code-text">onPointerOut</code></li>
</ul>
<p>Please note that these events will only work in browsers that support the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Pointer_events">Pointer Events</a> specification. (At the time of this writing, this includes the latest versions of Chrome, Firefox, Edge, and Internet Explorer.) If your application depends on pointer events, we recommend using a third-party pointer events polyfill. We have opted not to include such a polyfill in React DOM, to avoid an increase in bundle size.</p>
<p><a href="https://codesandbox.io/api/v1/sandboxes/define?parameters=N4IgZglgNgpgziAXKADgQwMYGs0HMYB0AVnAPYB2SoGFALjObVSACYwoNvkYTzMBOMTE0QgoaenCYAaEIOEBaFqQC2SMRPhMAvrJVoIlUQEYAbAoAsCwbDRwYCgEZRSuBSlJSA9B8P1-CjAAbgy0cIEAHmgqKLDECNq6IIZsEQQAFrQqUMw0jKHqADwsEEEABBAsALwAOnKkpLR1AHyFXiVBzSBJZpbWMLb2Ti5uHt6--QHBoeEwUTFxJLl0BaIQMaT8tGUASkIY22D8qmUA5PIHpwDcNeTrHlu7-7QAIgDyALJlRyfnz0qqa63W55KRlADCAEkduCADIAUQA-gBlSEALXhZSqZQAHABWG7kEHiOBwMovfh4ABCpAiZTm9HILDJe2EBHBqg85FCZWAtzKZSkmixvP5ArK6Ts4LQKFoAFdBIhvmgoPZpGKBTx-BhYLCYGBaEqcQAGdXkcVlLU6mAAFVIKCNprF2kJAogcApeFwhlwIrAKvsrrKKEEQQgpDlcD1BpFxqDIeC4cjdpQscJYooL1IAHdzdjpowsc1RebxbR0u6CO7PbhveRfdjaPw5TAgwKC7QCLQ0Px8J37LQAAqkPwwfjS2UKmAACg7BAm_khLAAlOnSwKvF4ygB1GCC2ibPflveGCC0CAqy0NfglciaMkHsqOPdoZxH0iWlUYOXiehlY-WpK9bwBqZSbmUv5jmUFAEKB5aVgylIHMOcBnuG5AvAM3aziEjCrs6a4ChQHykCEIodkWJYWhAYBlNOACE8FwFWHqUrWPrLlRFplII8r8OQbZlNooGgtswCwAa0j_va2gikxBCIcIKFoZmWFoDhoT4US67_hWzEDsi3b0NO07AFaur6rQUnmbaMmcVUxamaBmoQNqFkGkqNnRtsADUEGWWa3GWq51opp5IWwCmZR-QeKCBeK2jLlpAousCpYUAAqqm-a4dsDl0fJ1ZsXWDbKqqMDJdB5AAOKNBOfF7jlPL5fJBlGTOwCSnA9VTkqTYtolQYULCni0D1gjkblRZwXpBBtZopldeNMBKv65WDWl7YRE2SmeCpGFqZNzXFnyOmif5MZNYw854DAAAagnnbFR3Xeg-AAJqPRQYJsFA3YiqdQUSYaF3bAoumVgmYYRlGAXOdJDoI2U4PyVDSZwCm8UpYJqOhuj3kisDOOzWjMNRY29qCbxCrmr93ZBql2kCoITJjtOnGA-K52dVKMoNdZEUwN5AtubZKCyY2s1CvQhFc992yOLShkAJ6wAD8OKzeY5KqcxgoHSZBQJUZQAMQsAAnBbFunFj4r6L2hg68Yxr62UxplAATC7EQ2_DKiGAAEjAEC4JkSoWMaTo6QK2aVOWTuRwApL70fBnt54UDrNgSKUMApxajMifLwWiyravYpzFqxyw8cQtCcJIqiGK2wK6TB6HINQjCCIoui8It0-mxsPwOxoCUkZKl3De9xiYGewPYz7Trr6G3K9D59xwPhaLwvw7F2-hfaA-OJgWC4MccpMhyLj8EqS181OZQAPxnM4LanGUOvnzADAbxaB5ygwOkAAggcdCOtyAUDzrbQuOlqb8TovDYopR9yqxgFUYAisIhlxgNoZo8MBTIKCAQ8UUg0EYJsjg4SqcLQUGHKOfgWZcwYPkpmHM5BqFBVoeQehkwSIhBYbNYipFcEkKIjwkckwsqCMrJlcWYiqq8P8NKbgAwZHMTkZwrh4japDkkcoh-gh1EEAoLo5aWjtHDVGkoscy1jFWKkOYkhXh8GpzaB0VxFpKrUOobcVkBx3gfAICzYe04xSFBrDSOkLj4rKG_CoUIBA-zwlgAkxgVJlZLmnOcBotBTjLluFpboiQgA" target="_blank" rel="noreferrer">Check out this example on CodeSandbox.</a></p>
<p>Huge thanks to <a href="https://github.com/philipp-spiess">Philipp Spiess</a> for contributing this change!</p>
<h2 id="bugfix-for-getderivedstatefromprops"><a href="#bugfix-for-getderivedstatefromprops" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Bugfix for <code class="gatsby-code-text">getDerivedStateFromProps</code></h2>
<p><code class="gatsby-code-text">getDerivedStateFromProps</code> is now called every time a component is rendered, regardless of the cause of the update. Previously, it was only called if the component was re-rendered by its parent, and would not fire as the result of a local <code class="gatsby-code-text">setState</code>. This was an oversight in the initial implementation that has now been corrected. The previous behavior was more similar to <code class="gatsby-code-text">componentWillReceiveProps</code>, but the improved behavior ensures compatibility with React’s upcoming asynchronous rendering mode.</p>
<p><strong>This bug fix will not affect most apps</strong>, but it may cause issues with a small fraction of components. The rare cases where it does matter fall into one of two categories:</p>
<h3 id="1-avoid-side-effects-in-getderivedstatefromprops"><a href="#1-avoid-side-effects-in-getderivedstatefromprops" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>1. Avoid Side Effects in <code class="gatsby-code-text">getDerivedStateFromProps</code></h3>
<p>Like the render method, <code class="gatsby-code-text">getDerivedStateFromProps</code> should be a pure function of props and state. Side effects in <code class="gatsby-code-text">getDerivedStateFromProps</code> were never supported, but since it now fires more often than it used to, the recent change may expose previously undiscovered bugs.</p>
<p>Side effectful code should be moved to other methods: for example, Flux dispatches typically belong inside the originating event handler, and manual DOM mutations belong inside componentDidMount or componentDidUpdate. You can read more about this in our recent post about <a href="/reactdoc/blog/2018/03/27/update-on-async-rendering.html">preparing for asynchronous rendering</a>.</p>
<h3 id="2-compare-incoming-props-to-previous-props-when-computing-controlled-values"><a href="#2-compare-incoming-props-to-previous-props-when-computing-controlled-values" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>2. Compare Incoming Props to Previous Props When Computing Controlled Values</h3>
<p>The following code assumes <code class="gatsby-code-text">getDerivedStateFromProps</code> only fires on prop changes:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>value <span class="token operator">!==</span> state<span class="token punctuation">.</span>controlledValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// Since this method fires on both props and state changes, local updates</span>
      <span class="token comment">// to the controlled value will be ignored, because the props version</span>
      <span class="token comment">// always overrides it. Oops!</span>
      controlledValue<span class="token punctuation">:</span> props<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>One possible way to fix this is to compare the incoming value to the previous value by storing the previous props in state:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prevProps <span class="token operator">=</span> state<span class="token punctuation">.</span>prevProps<span class="token punctuation">;</span>
  <span class="token comment">// Compare the incoming prop to previous prop</span>
  <span class="token keyword">const</span> controlledValue <span class="token operator">=</span>
    prevProps<span class="token punctuation">.</span>value <span class="token operator">!==</span> props<span class="token punctuation">.</span>value
      <span class="token operator">?</span> props<span class="token punctuation">.</span>value
      <span class="token punctuation">:</span> state<span class="token punctuation">.</span>controlledValue<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// Store the previous props in state</span>
    prevProps<span class="token punctuation">:</span> props<span class="token punctuation">,</span>
    controlledValue<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>However, <strong>code that “mirrors” props in state usually contains bugs</strong>, whether you use the newer <code class="gatsby-code-text">getDerivedStateFromProps</code> or the legacy <code class="gatsby-code-text">componentWillReceiveProps</code>. We published a follow-up blog post that explains these problems in more detail, and suggests <a href="/reactdoc/blog/2018/06/07/you-probably-dont-need-derived-state.html">simpler solutions that don’t involve <code class="gatsby-code-text">getDerivedStateFromProps()</code></a>.</p>
<h2 id="installation"><a href="#installation" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation</h2>
<p>React v16.4.0 is available on the npm registry.</p>
<p>To install React 16 with Yarn, run:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash">yarn add react@^16.4.0 react-dom@^16.4.0</code></pre></div>
<p>To install React 16 with npm, run:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token function">npm</span> <span class="token function">install</span> --save react@^16.4.0 react-dom@^16.4.0</code></pre></div>
<p>We also provide UMD builds of React via a CDN:</p>
<div class="gatsby-highlight" data-language="html"><pre class="gatsby-code-html"><code class="gatsby-code-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react@16/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">crossorigin</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@16/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre></div>
<p>Refer to the documentation for <a href="/reactdoc/docs/installation.html">detailed installation instructions</a>.</p>
<h2 id="changelog"><a href="#changelog" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Changelog</h2>
<h3 id="react"><a href="#react" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React</h3>
<ul>
<li>Add a new <a href="https://github.com/reactjs/rfcs/pull/51">experimental</a> <code class="gatsby-code-text">React.unstable_Profiler</code> component for measuring performance. (<a href="https://github.com/bvaughn">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/12745">#12745</a>)</li>
</ul>
<h3 id="react-dom"><a href="#react-dom" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React DOM</h3>
<ul>
<li>Add support for the Pointer Events specification. (<a href="https://github.com/philipp-spiess">@philipp-spiess</a> in <a href="https://github.com/facebook/react/pull/12507">#12507</a>)</li>
<li>Properly call <code class="gatsby-code-text">getDerivedStateFromProps()</code> regardless of the reason for re-rendering. (<a href="https://github.com/acdlite">@acdlite</a> in <a href="https://github.com/facebook/react/pull/12600">#12600</a> and <a href="https://github.com/facebook/react/pull/12802">#12802</a>)</li>
<li>Fix a bug that prevented context propagation in some cases. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12708">#12708</a>)</li>
<li>Fix re-rendering of components using <code class="gatsby-code-text">forwardRef()</code> on a deeper <code class="gatsby-code-text">setState()</code>. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12690">#12690</a>)</li>
<li>Fix some attributes incorrectly getting removed from custom element nodes. (<a href="https://github.com/airamrguez">@airamrguez</a> in <a href="https://github.com/facebook/react/pull/12702">#12702</a>)</li>
<li>Fix context providers to not bail out on children if there’s a legacy context provider above. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12586">#12586</a>)</li>
<li>Add the ability to specify <code class="gatsby-code-text">propTypes</code> on a context provider component. (<a href="https://github.com/nicolevy">@nicolevy</a> in <a href="https://github.com/facebook/react/pull/12658">#12658</a>)</li>
<li>Fix a false positive warning when using <code class="gatsby-code-text">react-lifecycles-compat</code> in <code class="gatsby-code-text">&lt;StrictMode&gt;</code>. (<a href="https://github.com/bvaughn">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/12644">#12644</a>)</li>
<li>Warn when the <code class="gatsby-code-text">forwardRef()</code> render function has <code class="gatsby-code-text">propTypes</code> or <code class="gatsby-code-text">defaultProps</code>. (<a href="https://github.com/bvaughn">@bvaughn</a> in <a href="https://github.com/facebook/react/pull/12644">#12644</a>)</li>
<li>Improve how <code class="gatsby-code-text">forwardRef()</code> and context consumers are displayed in the component stack. (<a href="https://github.com/sophiebits">@sophiebits</a> in <a href="https://github.com/facebook/react/pull/12777">#12777</a>)</li>
<li>Change internal event names. This can break third-party packages that rely on React internals in unsupported ways. (<a href="https://github.com/philipp-spiess">@philipp-spiess</a> in <a href="https://github.com/facebook/react/pull/12629">#12629</a>)</li>
</ul>
<h3 id="react-test-renderer"><a href="#react-test-renderer" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React Test Renderer</h3>
<ul>
<li>Fix the <code class="gatsby-code-text">getDerivedStateFromProps()</code> support to match the new React DOM behavior. (<a href="https://github.com/koba04">@koba04</a> in <a href="https://github.com/facebook/react/pull/12676">#12676</a>)</li>
<li>Fix a <code class="gatsby-code-text">testInstance.parent</code> crash when the parent is a fragment or another special node. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12813">#12813</a>)</li>
<li><code class="gatsby-code-text">forwardRef()</code> components are now discoverable by the test renderer traversal methods. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12725">#12725</a>)</li>
<li>Shallow renderer now ignores <code class="gatsby-code-text">setState()</code> updaters that return <code class="gatsby-code-text">null</code> or <code class="gatsby-code-text">undefined</code>. (<a href="https://github.com/koba04">@koba04</a> in <a href="https://github.com/facebook/react/pull/12756">#12756</a>)</li>
</ul>
<h3 id="react-art"><a href="#react-art" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React ART</h3>
<ul>
<li>Fix reading context provided from the tree managed by React DOM. (<a href="https://github.com/acdlite">@acdlite</a> in <a href="https://github.com/facebook/react/pull/12779">#12779</a>)</li>
</ul>
<h3 id="react-call-return-experimental"><a href="#react-call-return-experimental" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React Call Return (Experimental)</h3>
<ul>
<li>This experiment was deleted because it was affecting the bundle size and the API wasn’t good enough. It’s likely to come back in the future in some other form. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12820">#12820</a>)</li>
</ul>
<h3 id="react-reconciler-experimental"><a href="#react-reconciler-experimental" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>React Reconciler (Experimental)</h3>
<ul>
<li>The <a href="https://github.com/facebook/react/blob/c601f7a64640290af85c9f0e33c78480656b46bc/packages/react-noop-renderer/src/createReactNoop.js#L82-L285">new host config shape</a> is flat and doesn’t use nested objects. (<a href="https://github.com/gaearon">@gaearon</a> in <a href="https://github.com/facebook/react/pull/12792">#12792</a>)</li>
</ul>]]></description><link>https://reactjs.org/blog/2018/05/23/react-v-16-4.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/05/23/react-v-16-4.html</guid><pubDate>Wed, 23 May 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[React v16.3.0: New lifecycles and context API]]></title><description><![CDATA[<p>A few days ago, we <a href="/reactdoc/blog/2018/03/27/update-on-async-rendering.html">wrote a post about upcoming changes to our legacy lifecycle methods</a>, including gradual migration strategies. In React 16.3.0, we are adding a few new lifecycle methods to assist with that migration. We are also introducing new APIs for long requested features: an official context API, a ref forwarding API, and an ergonomic ref API.</p>
<p>Read on to learn more about the release.</p>
<h2 id="official-context-api"><a href="#official-context-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Official Context API</h2>
<p>For many years, React has offered an experimental API for context. Although it was a powerful tool, its use was discouraged because of inherent problems in the API, and because we always intended to replace the experimental API with a better one.</p>
<p>Version 16.3 introduces a new context API that is more efficient and supports both static type checking and deep updates.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>The old context API will keep working for all React 16.x releases, so you will have time to migrate.</p>
</blockquote>
<p>Here is an example illustrating how you might inject a “theme” using the new context API:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> ThemeContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token string">'light'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
<span class="token keyword">class</span> <span class="token class-name">ThemeProvider</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>theme<span class="token punctuation">:</span> <span class="token string">'light'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Provider</span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>theme<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
</span><span class="gatsby-highlight-code-line"><span class="token plain-text">        </span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token plain-text"></span>
</span><span class="gatsby-highlight-code-line"><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Provider</span><span class="token punctuation">></span></span>
</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ThemedButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
<span class="gatsby-highlight-code-line">      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ThemeContext.Consumer</span><span class="token punctuation">></span></span><span class="token plain-text"></span>
</span><span class="gatsby-highlight-code-line"><span class="token plain-text">        </span><span class="token punctuation">{</span>theme <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Button</span> <span class="token attr-name">theme</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>theme<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text"></span>
</span><span class="gatsby-highlight-code-line"><span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ThemeContext.Consumer</span><span class="token punctuation">></span></span>
</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p><a href="/reactdoc/docs/context.html">Learn more about the new context API here.</a></p>
<h2 id="createref-api"><a href="#createref-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="gatsby-code-text">createRef</code> API</h2>
<p>Previously, React provided two ways of managing refs: the legacy string ref API and the callback API. Although the string ref API was the more convenient of the two, it had <a href="https://github.com/facebook/react/issues/1373">several downsides</a> and so our official recommendation was to use the callback form instead.</p>
<p>Version 16.3 adds a new option for managing refs that offers the convenience of a string ref without any of the downsides:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">MyComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>inputRef <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>inputRef<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
</span>  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>inputRef<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<blockquote>
<p><strong>Note:</strong></p>
<p>Callback refs will continue to be supported in addition to the new <code class="gatsby-code-text">createRef</code> API.</p>
<p>You don’t need to replace callback refs in your components. They are slightly more flexible, so they will remain as an advanced feature.</p>
</blockquote>
<p><a href="/reactdoc/docs/refs-and-the-dom.html">Learn more about the new <code class="gatsby-code-text">createRef</code> API here.</a></p>
<h2 id="forwardref-api"><a href="#forwardref-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="gatsby-code-text">forwardRef</code> API</h2>
<p>Generally, React components are declarative, but sometimes imperative access to the component instances and the underlying DOM nodes is necessary. This is common for use cases like managing focus, selection, or animations. React provides <a href="/reactdoc/docs/refs-and-the-dom.html">refs</a> as a way to solve this problem. However, component encapsulation poses some challenges with refs.</p>
<p>For example, if you replace a <code class="gatsby-code-text">&lt;button&gt;</code> with a custom <code class="gatsby-code-text">&lt;FancyButton&gt;</code> component, the <code class="gatsby-code-text">ref</code> attribute on it will start pointing at the wrapper component instead of the DOM node (and would be <code class="gatsby-code-text">null</code> for function components). While this is desirable for “application-level” components like <code class="gatsby-code-text">FeedStory</code> or <code class="gatsby-code-text">Comment</code> that need to be encapsulated, it can be annoying for “leaf” components such as <code class="gatsby-code-text">FancyButton</code> or <code class="gatsby-code-text">MyTextInput</code> that are typically used like their DOM counterparts, and might need to expose their DOM nodes.</p>
<p>Ref forwarding is a new opt-in feature that lets some components take a <code class="gatsby-code-text">ref</code> they receive, and pass it further down (in other words, “forward” it) to a child. In the example below, <code class="gatsby-code-text">FancyButton</code> forwards its ref to a DOM <code class="gatsby-code-text">button</code> that it renders:</p>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="gatsby-highlight-code-line"><span class="token keyword">const</span> FancyButton <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">forwardRef</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> ref<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FancyButton<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
</span><span class="token plain-text">    </span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// You can now get a ref directly to the DOM button:</span>
<span class="token keyword">const</span> ref <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FancyButton</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">Click me!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FancyButton</span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code></pre>
        </div></p>
<p>This way, components using <code class="gatsby-code-text">FancyButton</code> can get a ref to the underlying <code class="gatsby-code-text">button</code> DOM node and access it if necessary—just like if they used a DOM <code class="gatsby-code-text">button</code> directly.</p>
<p>Ref forwarding is not limited to “leaf” components that render DOM nodes. If you write <a href="/reactdoc/docs/higher-order-components.html">higher order components</a>, we recommend using ref forwarding to automatically pass the ref down to the wrapped class component instances.</p>
<p><a href="/reactdoc/docs/forwarding-refs.html">Learn more about the forwardRef API here.</a></p>
<h2 id="component-lifecycle-changes"><a href="#component-lifecycle-changes" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Component Lifecycle Changes</h2>
<p>React’s class component API has been around for years with little change. However, as we add support for more advanced features (such as <a href="/reactdoc/docs/react-component.html#componentdidcatch">error boundaries</a> and the upcoming <a href="/reactdoc/blog/2018/03/01/sneak-peek-beyond-react-16.html">async rendering mode</a>) we stretch this model in ways that it was not originally intended.</p>
<p>For example, with the current API, it is too easy to block the initial render with non-essential logic. In part this is because there are too many ways to accomplish a given task, and it can be unclear which is best. We’ve observed that the interrupting behavior of error handling is often not taken into consideration and can result in memory leaks (something that will also impact the upcoming async rendering mode). The current class component API also complicates other efforts, like our work on <a href="https://twitter.com/trueadm/status/944908776896978946">prototyping a React compiler</a>.</p>
<p>Many of these issues are exacerbated by a subset of the component lifecycles (<code class="gatsby-code-text">componentWillMount</code>, <code class="gatsby-code-text">componentWillReceiveProps</code>, and <code class="gatsby-code-text">componentWillUpdate</code>). These also happen to be the lifecycles that cause the most confusion within the React community. For these reasons, we are going to deprecate those methods in favor of better alternatives.</p>
<p>We recognize that this change will impact many existing components. Because of this, the migration path will be as gradual as possible, and will provide escape hatches. (At Facebook, we maintain more than 50,000 React components. We depend on a gradual release cycle too!)</p>
<blockquote>
<p><strong>Note:</strong></p>
<p>Deprecation warnings will be enabled with a future 16.x release, <strong>but the legacy lifecycles will continue to work until version 17</strong>.</p>
<p>Even in version 17, it will still be possible to use them, but they will be aliased with an “UNSAFE_” prefix to indicate that they might cause issues. We have also prepared an <a href="https://github.com/reactjs/react-codemod#rename-unsafe-lifecycles">automated script to rename them</a> in existing code.</p>
</blockquote>
<p>In addition to deprecating unsafe lifecycles, we are also adding a couple of new lifecyles:</p>
<ul>
<li><a href="/reactdoc/docs/react-component.html#static-getderivedstatefromprops"><code class="gatsby-code-text">getDerivedStateFromProps</code></a> is being added as a safer alternative to the legacy <code class="gatsby-code-text">componentWillReceiveProps</code>. (Note that <a href="/reactdoc/blog/2018/06/07/you-probably-dont-need-derived-state.html">in most cases you don’t need either of them</a>.)</li>
<li><a href="/reactdoc/docs/react-component.html#getsnapshotbeforeupdate"><code class="gatsby-code-text">getSnapshotBeforeUpdate</code></a> is being added to support safely reading properties from e.g. the DOM before updates are made.</li>
</ul>
<p><a href="/reactdoc/blog/2018/03/27/update-on-async-rendering.html">Learn more about these lifecycle changes here.</a></p>
<h2 id="strictmode-component"><a href="#strictmode-component" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code class="gatsby-code-text">StrictMode</code> Component</h2>
<p><code class="gatsby-code-text">StrictMode</code> is a tool for highlighting potential problems in an application. Like <code class="gatsby-code-text">Fragment</code>, <code class="gatsby-code-text">StrictMode</code> does not render any visible UI. It activates additional checks and warnings for its descendants.</p>
<blockquote>
<p><strong>Note:</strong></p>
<p><code class="gatsby-code-text">StrictMode</code> checks are run in development mode only; <em>they do not impact the production build</em>.</p>
</blockquote>
<p>Although it is not possible for strict mode to catch all problems (e.g. certain types of mutation), it can help with many. If you see warnings in strict mode, those things will likely cause bugs for async rendering.</p>
<p>In version 16.3, <code class="gatsby-code-text">StrictMode</code> helps with:</p>
<ul>
<li>Identifying components with unsafe lifecycles</li>
<li>Warning about legacy string ref API usage</li>
<li>Detecting unexpected side effects</li>
</ul>
<p>Additional functionality will be added with future releases of React.</p>
<p><a href="/reactdoc/docs/strict-mode.html">Learn more about the <code class="gatsby-code-text">StrictMode</code> component here.</a></p>]]></description><link>https://reactjs.org/blog/2018/03/29/react-v-16-3.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/29/react-v-16-3.html</guid><pubDate>Thu, 29 Mar 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[Update on Async Rendering]]></title><description><![CDATA[<p>For over a year, the React team has been working to implement asynchronous rendering. Last month during his talk at JSConf Iceland, <a href="/reactdoc/blog/2018/03/01/sneak-peek-beyond-react-16.html">Dan unveiled some of the exciting new possibilities async rendering unlocks</a>. Now we’d like to share with you some of the lessons we’ve learned while working on these features, and some recipes to help prepare your components for async rendering when it launches.</p>
<p>One of the biggest lessons we’ve learned is that some of our legacy component lifecycles tend to encourage unsafe coding practices. They are:</p>
<ul>
<li><code class="gatsby-code-text">componentWillMount</code></li>
<li><code class="gatsby-code-text">componentWillReceiveProps</code></li>
<li><code class="gatsby-code-text">componentWillUpdate</code></li>
</ul>
<p>These lifecycle methods have often been misunderstood and subtly misused; furthermore, we anticipate that their potential misuse may be more problematic with async rendering. Because of this, we will be adding an “UNSAFE_” prefix to these lifecycles in an upcoming release. (Here, “unsafe” refers not to security but instead conveys that code using these lifecycles will be more likely to have bugs in future versions of React, especially once async rendering is enabled.)</p>
<h2 id="gradual-migration-path"><a href="#gradual-migration-path" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Gradual Migration Path</h2>
<p><a href="/reactdoc/blog/2016/02/19/new-versioning-scheme.html">React follows semantic versioning</a>, so this change will be gradual. Our current plan is:</p>
<ul>
<li><strong>16.3</strong>: Introduce aliases for the unsafe lifecycles, <code class="gatsby-code-text">UNSAFE_componentWillMount</code>, <code class="gatsby-code-text">UNSAFE_componentWillReceiveProps</code>, and <code class="gatsby-code-text">UNSAFE_componentWillUpdate</code>. (Both the old lifecycle names and the new aliases will work in this release.)</li>
<li><strong>A future 16.x release</strong>: Enable deprecation warning for <code class="gatsby-code-text">componentWillMount</code>, <code class="gatsby-code-text">componentWillReceiveProps</code>, and <code class="gatsby-code-text">componentWillUpdate</code>. (Both the old lifecycle names and the new aliases will work in this release, but the old names will log a DEV-mode warning.)</li>
<li><strong>17.0</strong>: Remove <code class="gatsby-code-text">componentWillMount</code>, <code class="gatsby-code-text">componentWillReceiveProps</code>, and <code class="gatsby-code-text">componentWillUpdate</code> . (Only the new “UNSAFE_” lifecycle names will work from this point forward.)</li>
</ul>
<p><strong>Note that if you’re a React application developer, you don’t have to do anything about the legacy methods yet. The primary purpose of the upcoming version 16.3 release is to enable open source project maintainers to update their libraries in advance of any deprecation warnings. Those warnings will not be enabled until a future 16.x release.</strong></p>
<p>We maintain over 50,000 React components at Facebook, and we don’t plan to rewrite them all immediately. We understand that migrations take time. We will take the gradual migration path along with everyone in the React community.</p>
<hr>
<h2 id="migrating-from-legacy-lifecycles"><a href="#migrating-from-legacy-lifecycles" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Migrating from Legacy Lifecycles</h2>
<p>If you’d like to start using the new component APIs introduced in React 16.3 (or if you’re a maintainer looking to update your library in advance) here are a few examples that we hope will help you to start thinking about components a bit differently. Over time, we plan to add additional “recipes” to our documentation that show how to perform common tasks in a way that avoids the problematic lifecycles.</p>
<p>Before we begin, here’s a quick overview of the lifecycle changes planned for version 16.3:</p>
<ul>
<li>We are <strong>adding the following lifecycle aliases</strong>: <code class="gatsby-code-text">UNSAFE_componentWillMount</code>, <code class="gatsby-code-text">UNSAFE_componentWillReceiveProps</code>, and <code class="gatsby-code-text">UNSAFE_componentWillUpdate</code>. (Both the old lifecycle names and the new aliases will be supported.)</li>
<li>We are <strong>introducing two new lifecycles</strong>, static <code class="gatsby-code-text">getDerivedStateFromProps</code> and <code class="gatsby-code-text">getSnapshotBeforeUpdate</code>.</li>
</ul>
<h3 id="new-lifecycle-getderivedstatefromprops"><a href="#new-lifecycle-getderivedstatefromprops" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New lifecycle: <code class="gatsby-code-text">getDerivedStateFromProps</code></h3>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>The new static <code class="gatsby-code-text">getDerivedStateFromProps</code> lifecycle is invoked after a component is instantiated as well as before it is re-rendered. It can return an object to update <code class="gatsby-code-text">state</code>, or <code class="gatsby-code-text">null</code> to indicate that the new <code class="gatsby-code-text">props</code> do not require any <code class="gatsby-code-text">state</code> updates.</p>
<p>Together with <code class="gatsby-code-text">componentDidUpdate</code>, this new lifecycle should cover all use cases for the legacy <code class="gatsby-code-text">componentWillReceiveProps</code>.</p>
<blockquote>
<p>Note:</p>
<p>Both the older <code class="gatsby-code-text">componentWillReceiveProps</code> and the new <code class="gatsby-code-text">getDerivedStateFromProps</code> methods add significant complexity to components. This often leads to <a href="/reactdoc/blog/2018/06/07/you-probably-dont-need-derived-state.html#common-bugs-when-using-derived-state">bugs</a>. Consider <strong><a href="/reactdoc/blog/2018/06/07/you-probably-dont-need-derived-state.html">simpler alternatives to derived state</a></strong> to make components predictable and maintainable.</p>
</blockquote>
<h3 id="new-lifecycle-getsnapshotbeforeupdate"><a href="#new-lifecycle-getsnapshotbeforeupdate" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>New lifecycle: <code class="gatsby-code-text">getSnapshotBeforeUpdate</code></h3>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>The new <code class="gatsby-code-text">getSnapshotBeforeUpdate</code> lifecycle is called right before mutations are made (e.g. before the DOM is updated). The return value for this lifecycle will be passed as the third parameter to <code class="gatsby-code-text">componentDidUpdate</code>. (This lifecycle isn’t often needed, but can be useful in cases like manually preserving scroll position during rerenders.)</p>
<p>Together with <code class="gatsby-code-text">componentDidUpdate</code>, this new lifecycle should cover all use cases for the legacy <code class="gatsby-code-text">componentWillUpdate</code>.</p>
<p>You can find their type signatures <a href="https://gist.github.com/gaearon/88634d27abbc4feeb40a698f760f3264">in this gist</a>.</p>
<p>We’ll look at examples of how both of these lifecycles can be used below.</p>
<h2 id="examples"><a href="#examples" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Examples</h2>
<ul>
<li><a href="#initializing-state">Initializing state</a></li>
<li><a href="#fetching-external-data">Fetching external data</a></li>
<li><a href="#adding-event-listeners-or-subscriptions">Adding event listeners (or subscriptions)</a></li>
<li><a href="#updating-state-based-on-props">Updating <code class="gatsby-code-text">state</code> based on props</a></li>
<li><a href="#invoking-external-callbacks">Invoking external callbacks</a></li>
<li><a href="#side-effects-on-props-change">Side effects on props change</a></li>
<li><a href="#fetching-external-data-when-props-change">Fetching external data when props change</a></li>
<li><a href="#reading-dom-properties-before-an-update">Reading DOM properties before an update</a></li>
</ul>
<blockquote>
<p>Note</p>
<p>For brevity, the examples below are written using the experimental class properties transform, but the same migration strategies apply without it.</p>
</blockquote>
<h3 id="initializing-state"><a href="#initializing-state" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initializing state</h3>
<p>This example shows a component with <code class="gatsby-code-text">setState</code> calls inside of <code class="gatsby-code-text">componentWillMount</code>:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      currentColor<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>defaultColor<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      palette<span class="token punctuation">:</span> <span class="token string">'rgb'</span><span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<p>The simplest refactor for this type of component is to move state initialization to the constructor or to a property initializer, like so:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  state <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    currentColor<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>defaultColor<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">    palette<span class="token punctuation">:</span> <span class="token string">'rgb'</span><span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<h3 id="fetching-external-data"><a href="#fetching-external-data" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fetching external data</h3>
<p>Here is an example of a component that uses <code class="gatsby-code-text">componentWillMount</code> to fetch external data:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    externalData<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token function">loadMyAsyncData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      externalData <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>externalData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>externalData <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render loading state ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render real UI ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>The above code is problematic for both server rendering (where the external data won’t be used) and the upcoming async rendering mode (where the request might be initiated multiple times).</p>
<p>The recommended upgrade path for most use cases is to move data-fetching into <code class="gatsby-code-text">componentDidMount</code>:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    externalData<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token function">loadMyAsyncData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      externalData <span class="token operator">=></span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>externalData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>externalData <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render loading state ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render real UI ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>There is a common misconception that fetching in <code class="gatsby-code-text">componentWillMount</code> lets you avoid the first empty rendering state. In practice this was never true because React has always executed <code class="gatsby-code-text">render</code> immediately after <code class="gatsby-code-text">componentWillMount</code>. If the data is not available by the time <code class="gatsby-code-text">componentWillMount</code> fires, the first <code class="gatsby-code-text">render</code> will still show a loading state regardless of where you initiate the fetch. This is why moving the fetch to <code class="gatsby-code-text">componentDidMount</code> has no perceptible effect in the vast majority of cases.</p>
<blockquote>
<p>Note</p>
<p>Some advanced use-cases (e.g. libraries like Relay) may want to experiment with eagerly prefetching async data. An example of how this can be done is available <a href="https://gist.github.com/bvaughn/89700e525ff423a75ffb63b1b1e30a8f">here</a>.</p>
<p>In the longer term, the canonical way to fetch data in React components will likely be based on the “suspense” API <a href="/reactdoc/blog/2018/03/01/sneak-peek-beyond-react-16.html">introduced at JSConf Iceland</a>. Both simple data fetching solutions and libraries like Apollo and Relay will be able to use it under the hood. It is significantly less verbose than either of the above solutions, but will not be finalized in time for the 16.3 release.</p>
<p>When supporting server rendering, it’s currently necessary to provide the data synchronously – <code class="gatsby-code-text">componentWillMount</code> was often used for this purpose but the constructor can be used as a replacement. The upcoming suspense APIs will make async data fetching cleanly possible for both client and server rendering.</p>
</blockquote>
<h3 id="adding-event-listeners-or-subscriptions"><a href="#adding-event-listeners-or-subscriptions" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Adding event listeners (or subscriptions)</h3>
<p>Here is an example of a component that subscribes to an external event dispatcher when mounting:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      subscribedValue<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// This is not safe; it can leak!</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubscriptionChange
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubscriptionChange
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleSubscriptionChange</span> <span class="token operator">=</span> dataSource <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      subscribedValue<span class="token punctuation">:</span> dataSource<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>Unfortunately, this can cause memory leaks for server rendering (where <code class="gatsby-code-text">componentWillUnmount</code> will never be called) and async rendering (where rendering might be interrupted before it completes, causing <code class="gatsby-code-text">componentWillUnmount</code> not to be called).</p>
<p>People often assume that <code class="gatsby-code-text">componentWillMount</code> and <code class="gatsby-code-text">componentWillUnmount</code> are always paired, but that is not guaranteed. Only once <code class="gatsby-code-text">componentDidMount</code> has been called does React guarantee that <code class="gatsby-code-text">componentWillUnmount</code> will later be called for clean up.</p>
<p>For this reason, the recommended way to add listeners/subscriptions is to use the <code class="gatsby-code-text">componentDidMount</code> lifecycle:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  state <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    subscribedValue<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">
</span><span class="gatsby-highlight-code-line">  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Event listeners are only safe to add after mount,</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// So they won't leak if mount is interrupted or errors.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubscriptionChange
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// External values could change between render and mount,</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// In some cases it may be important to handle this case.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>subscribedValue <span class="token operator">!==</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>value
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        subscribedValue<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>dataSource<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleSubscriptionChange
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">handleSubscriptionChange</span> <span class="token operator">=</span> dataSource <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      subscribedValue<span class="token punctuation">:</span> dataSource<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>Sometimes it is important to update subscriptions in response to property changes. If you’re using a library like Redux or MobX, the library’s container component should handle this for you. For application authors, we’ve created a small library, <a href="https://github.com/facebook/react/tree/master/packages/create-subscription"><code class="gatsby-code-text">create-subscription</code></a>, to help with this. We’ll publish it along with React 16.3.</p>
<p>Rather than passing a subscribable <code class="gatsby-code-text">dataSource</code> prop as we did in the example above, we could use <code class="gatsby-code-text">create-subscription</code> to pass in the subscribed value:</p>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createSubscription<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'create-subscription'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> Subscription <span class="token operator">=</span> <span class="token function">createSubscription</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">getCurrentValue</span><span class="token punctuation">(</span>sourceProp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Return the current value of the subscription (sourceProp).</span>
    <span class="token keyword">return</span> sourceProp<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">subscribe</span><span class="token punctuation">(</span>sourceProp<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">handleSubscriptionChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>sourceProp<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Subscribe (e.g. add an event listener) to the subscription (sourceProp).</span>
    <span class="token comment">// Call callback(newValue) whenever a subscription changes.</span>
    sourceProp<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>handleSubscriptionChange<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Return an unsubscribe method.</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sourceProp<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span>handleSubscriptionChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Rather than passing the subscribable source to our ExampleComponent,</span>
<span class="token comment">// We could just pass the subscribed value directly:</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Subscription</span> <span class="token attr-name">source</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>dataSource<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text">
  </span><span class="token punctuation">{</span>value <span class="token operator">=></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ExampleComponent</span> <span class="token attr-name">subscribedValue</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">}</span><span class="token plain-text">
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Subscription</span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code></pre>
        </div></p>
<blockquote>
<p>Note</p>
<p>Libraries like Relay/Apollo should manage subscriptions manually with the same techniques as <code class="gatsby-code-text">create-subscription</code> uses under the hood (as referenced <a href="https://gist.github.com/bvaughn/d569177d70b50b58bff69c3c4a5353f3">here</a>) in a way that is most optimized for their library usage.</p>
</blockquote>
<h3 id="updating-state-based-on-props"><a href="#updating-state-based-on-props" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Updating <code class="gatsby-code-text">state</code> based on <code class="gatsby-code-text">props</code></h3>
<blockquote>
<p>Note:</p>
<p>Both the older <code class="gatsby-code-text">componentWillReceiveProps</code> and the new <code class="gatsby-code-text">getDerivedStateFromProps</code> methods add significant complexity to components. This often leads to <a href="/reactdoc/blog/2018/06/07/you-probably-dont-need-derived-state.html#common-bugs-when-using-derived-state">bugs</a>. Consider <strong><a href="/reactdoc/blog/2018/06/07/you-probably-dont-need-derived-state.html">simpler alternatives to derived state</a></strong> to make components predictable and maintainable.</p>
</blockquote>
<p>Here is an example of a component that uses the legacy <code class="gatsby-code-text">componentWillReceiveProps</code> lifecycle to update <code class="gatsby-code-text">state</code> based on new <code class="gatsby-code-text">props</code> values:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    isScrollingDown<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>currentRow <span class="token operator">!==</span> nextProps<span class="token punctuation">.</span>currentRow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        isScrollingDown<span class="token punctuation">:</span>
</span><span class="gatsby-highlight-code-line">          nextProps<span class="token punctuation">.</span>currentRow <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>currentRow<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<p>Although the above code is not problematic in itself, the <code class="gatsby-code-text">componentWillReceiveProps</code> lifecycle is often mis-used in ways that <em>do</em> present problems. Because of this, the method will be deprecated.</p>
<p>As of version 16.3, the recommended way to update <code class="gatsby-code-text">state</code> in response to <code class="gatsby-code-text">props</code> changes is with the new <code class="gatsby-code-text">static getDerivedStateFromProps</code> lifecycle. (That lifecycle is called when a component is created and each time it receives new props):
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token comment">// Initialize state in constructor,</span>
  <span class="token comment">// Or with a property initializer.</span>
<span class="gatsby-highlight-code-line">  state <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    isScrollingDown<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">    lastRow<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>currentRow <span class="token operator">!==</span> state<span class="token punctuation">.</span>lastRow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        isScrollingDown<span class="token punctuation">:</span> props<span class="token punctuation">.</span>currentRow <span class="token operator">></span> state<span class="token punctuation">.</span>lastRow<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">        lastRow<span class="token punctuation">:</span> props<span class="token punctuation">.</span>currentRow<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span>
    <span class="token comment">// Return null to indicate no change to state.</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>You may notice in the example above that <code class="gatsby-code-text">props.currentRow</code> is mirrored in state (as <code class="gatsby-code-text">state.lastRow</code>). This enables <code class="gatsby-code-text">getDerivedStateFromProps</code> to access the previous props value in the same way as is done in <code class="gatsby-code-text">componentWillReceiveProps</code>.</p>
<p>You may wonder why we don’t just pass previous props as a parameter to <code class="gatsby-code-text">getDerivedStateFromProps</code>. We considered this option when designing the API, but ultimately decided against it for two reasons:</p>
<ul>
<li>A <code class="gatsby-code-text">prevProps</code> parameter would be null the first time <code class="gatsby-code-text">getDerivedStateFromProps</code> was called (after instantiation), requiring an if-not-null check to be added any time <code class="gatsby-code-text">prevProps</code> was accessed.</li>
<li>Not passing the previous props to this function is a step toward freeing up memory in future versions of React. (If React does not need to pass previous props to lifecycles, then it does not need to keep the previous <code class="gatsby-code-text">props</code> object in memory.)</li>
</ul>
<blockquote>
<p>Note</p>
<p>If you’re writing a shared component, the <a href="https://github.com/reactjs/react-lifecycles-compat"><code class="gatsby-code-text">react-lifecycles-compat</code></a> polyfill enables the new <code class="gatsby-code-text">getDerivedStateFromProps</code> lifecycle to be used with older versions of React as well. <a href="#open-source-project-maintainers">Learn more about how to use it below.</a></p>
</blockquote>
<h3 id="invoking-external-callbacks"><a href="#invoking-external-callbacks" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Invoking external callbacks</h3>
<p>Here is an example of a component that calls an external function when its internal state changes:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>someStatefulValue <span class="token operator">!==</span>
</span><span class="gatsby-highlight-code-line">      nextState<span class="token punctuation">.</span>someStatefulValue
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      nextProps<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>nextState<span class="token punctuation">.</span>someStatefulValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<p>Sometimes people use <code class="gatsby-code-text">componentWillUpdate</code> out of a misplaced fear that by the time <code class="gatsby-code-text">componentDidUpdate</code> fires, it is “too late” to update the state of other components. This is not the case. React ensures that any <code class="gatsby-code-text">setState</code> calls that happen during <code class="gatsby-code-text">componentDidMount</code> and <code class="gatsby-code-text">componentDidUpdate</code> are flushed before the user sees the updated UI. In general, it is better to avoid cascading updates like this, but in some cases they are necessary (for example, if you need to position a tooltip after measuring the rendered DOM element).</p>
<p>Either way, it is unsafe to use <code class="gatsby-code-text">componentWillUpdate</code> for this purpose in async mode, because the external callback might get called multiple times for a single update. Instead, the <code class="gatsby-code-text">componentDidUpdate</code> lifecycle should be used since it is guaranteed to be invoked only once per update:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>someStatefulValue <span class="token operator">!==</span>
</span><span class="gatsby-highlight-code-line">      prevState<span class="token punctuation">.</span>someStatefulValue
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>someStatefulValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<h3 id="side-effects-on-props-change"><a href="#side-effects-on-props-change" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Side effects on props change</h3>
<p>Similar to the <a href="#invoking-external-callbacks">example above</a>, sometimes components have side effects when <code class="gatsby-code-text">props</code> change.</p>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible <span class="token operator">!==</span> nextProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token function">logVisibleChange</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<p>Like <code class="gatsby-code-text">componentWillUpdate</code>, <code class="gatsby-code-text">componentWillReceiveProps</code> might get called multiple times for a single update. For this reason it is important to avoid putting side effects in this method. Instead, <code class="gatsby-code-text">componentDidUpdate</code> should be used since it is guaranteed to be invoked only once per update:</p>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible <span class="token operator">!==</span> prevProps<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token function">logVisibleChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>isVisible<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span><span class="token punctuation">}</span></code></pre>
        </div></p>
<h3 id="fetching-external-data-when-props-change"><a href="#fetching-external-data-when-props-change" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fetching external data when <code class="gatsby-code-text">props</code> change</h3>
<p>Here is an example of a component that fetches external data based on <code class="gatsby-code-text">props</code> values:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// Before</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    externalData<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadAsyncData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentWillReceiveProps</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>id <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>externalData<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadAsyncData</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>externalData <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render loading state ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render real UI ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_loadAsyncData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token function">loadMyAsyncData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      externalData <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>externalData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>The recommended upgrade path for this component is to move data updates into <code class="gatsby-code-text">componentDidUpdate</code>. You can also use the new <code class="gatsby-code-text">getDerivedStateFromProps</code> lifecycle to clear stale data before rendering the new props:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token comment">// After</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  state <span class="token operator">=</span> <span class="token punctuation">{</span>
    externalData<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Store prevId in state so we can compare when props change.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Clear out previously-loaded data (so we don't render stale stuff).</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>id <span class="token operator">!==</span> state<span class="token punctuation">.</span>prevId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">        externalData<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">        prevId<span class="token punctuation">:</span> props<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">}</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// No state update necessary</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadAsyncData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>externalData <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_loadAsyncData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>externalData <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render loading state ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Render real UI ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">_loadAsyncData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token function">loadMyAsyncData</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
      externalData <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_asyncRequest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>externalData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<blockquote>
<p>Note</p>
<p>If you’re using an HTTP library that supports cancellation, like <a href="https://www.npmjs.com/package/axios">axios</a>, then it’s simple to cancel an in-progress request when unmounting. For native Promises, you can use an approach like <a href="https://gist.github.com/bvaughn/982ab689a41097237f6e9860db7ca8d6">the one shown here</a>.</p>
</blockquote>
<h3 id="reading-dom-properties-before-an-update"><a href="#reading-dom-properties-before-an-update" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Reading DOM properties before an update</h3>
<p>Here is an example of a component that reads a property from the DOM before an update in order to maintain scroll position within a list:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">ScrollingList</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  listRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  previousScrollOffset <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token function">componentWillUpdate</span><span class="token punctuation">(</span>nextProps<span class="token punctuation">,</span> nextState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Are we adding new items to the list?</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Capture the scroll position so we can adjust scroll later.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> nextProps<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>previousScrollOffset <span class="token operator">=</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollTop<span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// If previousScrollOffset is set, we've just added new items.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Adjust scroll so these new items don't push the old ones out of view.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>previousScrollOffset <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>previousScrollOffset<span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>previousScrollOffset <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>setListRef<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">        </span><span class="token punctuation">{</span><span class="token comment">/* ...contents... */</span><span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">setListRef</span> <span class="token operator">=</span> ref <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listRef <span class="token operator">=</span> ref<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<p>In the above example, <code class="gatsby-code-text">componentWillUpdate</code> is used to read the DOM property. However with async rendering, there may be delays between “render” phase lifecycles (like <code class="gatsby-code-text">componentWillUpdate</code> and <code class="gatsby-code-text">render</code>) and “commit” phase lifecycles (like <code class="gatsby-code-text">componentDidUpdate</code>). If the user does something like resize the window during this time, the <code class="gatsby-code-text">scrollHeight</code> value read from <code class="gatsby-code-text">componentWillUpdate</code> will be stale.</p>
<p>The solution to this problem is to use the new “commit” phase lifecycle, <code class="gatsby-code-text">getSnapshotBeforeUpdate</code>. This method gets called <em>immediately before</em> mutations are made (e.g. before the DOM is updated). It can return a value for React to pass as a parameter to <code class="gatsby-code-text">componentDidUpdate</code>, which gets called <em>immediately after</em> mutations.</p>
<p>The two lifecycles can be used together like this:</p>
<p><div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">class</span> <span class="token class-name">ScrollingList</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  listRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="gatsby-highlight-code-line">  <span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Are we adding new items to the list?</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Capture the scroll position so we can adjust scroll later.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevProps<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">return</span> <span class="token punctuation">(</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollTop
</span><span class="gatsby-highlight-code-line">      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">  <span class="token punctuation">}</span>
</span>
<span class="gatsby-highlight-code-line">  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// If we have a snapshot value, we've just added new items.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// Adjust scroll so these new items don't push the old ones out of view.</span>
</span><span class="gatsby-highlight-code-line">    <span class="token comment">// (snapshot here is the value returned from getSnapshotBeforeUpdate)</span>
</span><span class="gatsby-highlight-code-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="gatsby-highlight-code-line">      <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollTop <span class="token operator">=</span>
</span><span class="gatsby-highlight-code-line">        <span class="token keyword">this</span><span class="token punctuation">.</span>listRef<span class="token punctuation">.</span>scrollHeight <span class="token operator">-</span> snapshot<span class="token punctuation">;</span>
</span><span class="gatsby-highlight-code-line">    <span class="token punctuation">}</span>
</span>  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">ref</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>setListRef<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"></span>
<span class="token plain-text">        </span><span class="token punctuation">{</span><span class="token comment">/* ...contents... */</span><span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="token plain-text">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function-variable function">setListRef</span> <span class="token operator">=</span> ref <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listRef <span class="token operator">=</span> ref<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        </div></p>
<blockquote>
<p>Note</p>
<p>If you’re writing a shared component, the <a href="https://github.com/reactjs/react-lifecycles-compat"><code class="gatsby-code-text">react-lifecycles-compat</code></a> polyfill enables the new <code class="gatsby-code-text">getSnapshotBeforeUpdate</code> lifecycle to be used with older versions of React as well. <a href="#open-source-project-maintainers">Learn more about how to use it below.</a></p>
</blockquote>
<h2 id="other-scenarios"><a href="#other-scenarios" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Other scenarios</h2>
<p>While we tried to cover the most common use cases in this post, we recognize that we might have missed some of them. If you are using <code class="gatsby-code-text">componentWillMount</code>, <code class="gatsby-code-text">componentWillUpdate</code>, or <code class="gatsby-code-text">componentWillReceiveProps</code> in ways that aren’t covered by this blog post, and aren’t sure how to migrate off these legacy lifecycles, please <a href="https://github.com/reactjs/reactjs.org/issues/new">file a new issue against our documentation</a> with your code examples and as much background information as you can provide. We will update this document with new alternative patterns as they come up.</p>
<h2 id="open-source-project-maintainers"><a href="#open-source-project-maintainers" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Open source project maintainers</h2>
<p>Open source maintainers might be wondering what these changes mean for shared components. If you implement the above suggestions, what happens with components that depend on the new static <code class="gatsby-code-text">getDerivedStateFromProps</code> lifecycle? Do you also have to release a new major version and drop compatibility for React 16.2 and older?</p>
<p>Fortunately, you do not!</p>
<p>When React 16.3 is published, we’ll also publish a new npm package, <a href="https://github.com/reactjs/react-lifecycles-compat"><code class="gatsby-code-text">react-lifecycles-compat</code></a>. This package polyfills components so that the new <code class="gatsby-code-text">getDerivedStateFromProps</code> and <code class="gatsby-code-text">getSnapshotBeforeUpdate</code> lifecycles will also work with older versions of React (0.14.9+).</p>
<p>To use this polyfill, first add it as a dependency to your library:</p>
<div class="gatsby-highlight" data-language="bash"><pre class="gatsby-code-bash"><code class="gatsby-code-bash"><span class="token comment"># Yarn</span>
yarn add react-lifecycles-compat

<span class="token comment"># NPM</span>
<span class="token function">npm</span> <span class="token function">install</span> react-lifecycles-compat --save</code></pre></div>
<p>Next, update your components to use the new lifecycles (as described above).</p>
<p>Lastly, use the polyfill to make your component backwards compatible with older versions of React:
<div class="gatsby-highlight">
        <pre class="gatsby-code-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="gatsby-highlight-code-line"><span class="token keyword">import</span> <span class="token punctuation">{</span>polyfill<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-lifecycles-compat'</span><span class="token punctuation">;</span>
</span>
<span class="token keyword">class</span> <span class="token class-name">ExampleComponent</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
<span class="gatsby-highlight-code-line">  <span class="token keyword">static</span> <span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span>    <span class="token comment">// Your state update logic here ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Polyfill your component to work with older versions of React:</span>
<span class="gatsby-highlight-code-line"><span class="token function">polyfill</span><span class="token punctuation">(</span>ExampleComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> ExampleComponent<span class="token punctuation">;</span></code></pre>
        </div></p>]]></description><link>https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/27/update-on-async-rendering.html</guid><pubDate>Tue, 27 Mar 2018 07:00:00 GMT</pubDate></item><item><title><![CDATA[Sneak Peek: Beyond React 16]]></title><description><![CDATA[<p><a href="https://twitter.com/dan_abramov">Dan Abramov</a> from our team just spoke at <a href="https://2018.jsconf.is/">JSConf Iceland 2018</a> with a preview of some new features we’ve been working on in React. The talk opens with a question: “With vast differences in computing power and network speed, how do we deliver the best user experience for everyone?”</p>
<p>Here’s the video courtesy of JSConf Iceland:</p>
<br>
<div>
          <div
            class="gatsby-resp-iframe-wrapper"
            style="padding-bottom: 56.25%; position: relative; height: 0; overflow: hidden;"
          >
            <iframe src="https://www.youtube-nocookie.com/embed/nLF0n9SACd4?rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
          "></iframe>
          </div>
          </div>
<p>I think you’ll enjoy the talk more if you stop reading here and just watch the video. If you don’t have time to watch, a (very) brief summary follows.</p>
<h2 id="about-the-two-demos"><a href="#about-the-two-demos" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>About the Two Demos</h2>
<p>On the first demo, Dan says: “We’ve built a generic way to ensure that high-priority updates don’t get blocked by a low-priority update, called <strong>time slicing</strong>. If my device is fast enough, it feels almost like it’s synchronous; if my device is slow, the app still feels responsive. It adapts to the device thanks to the <a href="https://developers.google.com/web/updates/2015/08/using-requestidlecallback">requestIdleCallback</a> API. Notice that only the final state was displayed; the rendered screen is always consistent and we don’t see visual artifacts of slow rendering causing a janky user experience.”</p>
<p>On the second demo, Dan explains: “We’ve built a generic way for components to suspend rendering while they load async data, which we call <strong>suspense</strong>. You can pause any state update until the data is ready, and you can add async loading to any component deep in the tree without plumbing all the props and state through your app and hoisting the logic. On a fast network, updates appear very fluid and instantaneous without a jarring cascade of spinners that appear and disappear. On a slow network, you can intentionally design which loading states the user should see and how granular or coarse they should be, instead of showing spinners based on how the code is written. The app stays responsive throughout.”</p>
<p>“Importantly, this is still the React you know. This is still the declarative component paradigm that you probably like about React.”</p>
<p>We can’t wait to release these new async rendering features later this year. Follow this blog and <a href="https://twitter.com/reactjs">@reactjs on Twitter</a> for updates.</p>]]></description><link>https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html</link><guid isPermaLink="false">https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html</guid><pubDate>Thu, 01 Mar 2018 08:00:00 GMT</pubDate></item><item><title><![CDATA[Behind the Scenes: Improving the Repository Infrastructure]]></title><description><![CDATA[<p>As we worked on <a href="/reactdoc/blog/2017/09/26/react-v16.0.html">React 16</a>, we revamped the folder structure and much of the build tooling in the React repository. Among other things, we introduced projects such as <a href="https://rollupjs.org/">Rollup</a>, <a href="https://prettier.io/">Prettier</a>, and <a href="https://developers.google.com/closure/compiler/">Google Closure Compiler</a> into our workflow. People often ask us questions about how we use those tools. In this post, we would like to share some of the changes that we’ve made to our build and test infrastructure in 2017, and what motivated them.</p>
<p>While these changes helped us make React better, they don’t affect most React users directly. However, we hope that blogging about them might help other library authors solve similar problems. Our contributors might also find these notes helpful!</p>
<h2 id="formatting-code-with-prettier"><a href="#formatting-code-with-prettier" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Formatting Code with Prettier</h2>
<p>React was one of the first large repositories to <a href="https://github.com/facebook/react/pull/9101">fully embrace</a> opinionated automatic code formatting with <a href="https://prettier.io/">Prettier</a>. Our current Prettier setup consists of:</p>
<ul>
<li>A local <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/package.json#L115"><code class="gatsby-code-text">yarn prettier</code></a> script that <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/prettier/index.js#L71-L77">uses the Prettier Node API</a> to format files in place. We typically run it before committing changes. It is fast because it only checks the <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/shared/listChangedFiles.js#L29-L33">files changed since diverging from remote master</a>.</li>
<li>A script that <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/prettier/index.js#L79-L90">runs Prettier</a> as part of our <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/circleci/test_entry_point.sh#L10">continuous integration checks</a>. It won’t attempt to overwrite the files, but instead will fail the build if any file differs from the Prettier output for that file. This ensures that we can’t merge a pull request unless it has been fully formatted.</li>
</ul>
<p>Some team members have also set up the <a href="https://prettier.io/docs/en/editors.html">editor integrations</a>. Our experience with Prettier has been fantastic, and we recommend it to any team that writes JavaScript.</p>
<h2 id="restructuring-the-monorepo"><a href="#restructuring-the-monorepo" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Restructuring the Monorepo</h2>
<p>Ever since React was split into packages, it has been a <a href="https://danluu.com/monorepo/">monorepo</a>: a set of packages under the umbrella of a single repository. This made it easier to coordinate changes and share the tooling, but our folder structure was deeply nested and difficult to understand. It was not clear which files belonged to which package. After releasing React 16, we’ve decided to completely reorganize the repository structure. Here is how we did it.</p>
<h3 id="migrating-to-yarn-workspaces"><a href="#migrating-to-yarn-workspaces" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Migrating to Yarn Workspaces</h3>
<p>The Yarn package manager <a href="https://yarnpkg.com/blog/2017/08/02/introducing-workspaces/">introduced a feature called Workspaces</a> a few months ago. This feature lets you tell Yarn where your monorepo’s packages are located in the source tree. Every time you run <code class="gatsby-code-text">yarn</code>, in addition to installing your dependencies it also sets up the symlinks that point from your project’s <code class="gatsby-code-text">node_modules</code> to the source folders of your packages.</p>
<p>Thanks to Workspaces, absolute imports between our own packages (such as importing <code class="gatsby-code-text">react</code> from <code class="gatsby-code-text">react-dom</code>) “just work” with any tools that support the Node resolution mechanism. The only problem we encountered was Jest not running the transforms inside the linked packages, but we <a href="https://github.com/facebook/jest/pull/4761">found a fix</a>, and it was merged into Jest.</p>
<p>To enable Yarn Workspaces, we added <code class="gatsby-code-text">&quot;workspaces&quot;: [&quot;packages/*&quot;]</code> to our <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/package.json#L4-L6"><code class="gatsby-code-text">package.json</code></a>, and moved all the code into <a href="https://github.com/facebook/react/tree/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages">top-level <code class="gatsby-code-text">packages/*</code> folders</a>, each with its own <code class="gatsby-code-text">package.json</code> file.</p>
<p>Each package is structured in a similar way. For every public API entry point such as <code class="gatsby-code-text">react-dom</code> or <code class="gatsby-code-text">react-dom/server</code>, there is a <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/react-dom/index.js">file</a> in the package root folder that re-exports the implementation from the <a href="https://github.com/facebook/react/tree/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/react-dom/src"><code class="gatsby-code-text">/src/</code></a> subfolder. The decision to point entry points to the source rather than to the built versions was intentional. Typically, we re-run a subset of tests after every change during development. Having to build the project to run a test would have been prohibitively slow. When we publish packages to npm, we replace these entry points with files in the <a href="https://github.com/facebook/react/tree/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/react-dom/npm"><code class="gatsby-code-text">/npm/</code></a> folder that point to the build artifacts.</p>
<p>Not all packages have to be published on npm. For example, we keep some utilities that are tiny enough and can be safely duplicated in a <a href="https://github.com/facebook/react/tree/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/shared">pseudo-package called <code class="gatsby-code-text">shared</code></a>. Our bundler is configured to <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/build.js#L326-L329">only treat <code class="gatsby-code-text">dependencies</code> declared from <code class="gatsby-code-text">package.json</code> as externals</a> so it happily bundles the <code class="gatsby-code-text">shared</code> code into <code class="gatsby-code-text">react</code> and <code class="gatsby-code-text">react-dom</code> without leaving any references to <code class="gatsby-code-text">shared/</code> in the build artifacts. So you can use Yarn Workspaces even if you don’t plan to publish actual npm packages!</p>
<h3 id="removing-the-custom-module-system"><a href="#removing-the-custom-module-system" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Removing the Custom Module System</h3>
<p>In the past, we used a non-standard module system called “Haste” that lets you import any file from any other file by its unique <code class="gatsby-code-text">@providesModule</code> directive no matter where it is in the tree. It neatly avoids the problem of deep relative imports with paths like <code class="gatsby-code-text">../../../../</code> and is great for the product code. However, this makes it hard to understand the dependencies between packages. We also had to resort to hacks to make it work with different tools.</p>
<p>We decided to <a href="https://github.com/facebook/react/pull/11303">remove Haste</a> and use the Node resolution with relative imports instead. To avoid the problem of deep relative paths, we have <a href="https://github.com/facebook/react/pull/11304">flattened our repository structure</a> so that it goes at most one level deep inside each package:</p>
<div class="gatsby-highlight" data-language="text"><pre class="gatsby-code-text"><code class="gatsby-code-text">|-react
|  |-npm
|  |-src
|-react-dom
|  |-npm
|  |-src
|  |  |-client
|  |  |-events
|  |  |-server
|  |  |-shared</code></pre></div>
<p>This way, the relative paths can only contain one <code class="gatsby-code-text">./</code> or <code class="gatsby-code-text">../</code> followed by the filename. If one package needs to import something from another package, it can do so with an absolute import from a top-level entry point.</p>
<p>In practice, we still have <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/react-dom/src/client/ReactDOMFiberComponent.js#L10-L11">some cross-package “internal” imports</a> that violate this principle, but they’re explicit, and we plan to gradually get rid of them.</p>
<h2 id="compiling-flat-bundles"><a href="#compiling-flat-bundles" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Compiling Flat Bundles</h2>
<p>Historically, React was distributed in two different formats: as a single-file build that you can add as a <code class="gatsby-code-text">&lt;script&gt;</code> tag in the browser, and as a collection of CommonJS modules that you can bundle with a tool like webpack or Browserify. </p>
<p>Before React 16, each React source file had a corresponding CommonJS module that was published as part of the npm packages. Importing <code class="gatsby-code-text">react</code> or <code class="gatsby-code-text">react-dom</code> led bundlers to the package <a href="https://unpkg.com/react@15/index.js">entry point</a> from which they would build a dependency tree with the CommonJS modules in the <a href="https://unpkg.com/react@15/lib/">internal <code class="gatsby-code-text">lib</code> folder</a>.</p>
<p>However, this approach had multiple disadvantages:</p>
<ul>
<li><strong>It was inconsistent.</strong> Different tools produce bundles of different sizes for identical code importing React, with the difference going as far as 30 kB (before gzip).</li>
<li><strong>It was inefficient for bundler users.</strong> The code produced by most bundlers today contains a lot of “glue code” at the module boundaries. It keeps the modules isolated from each other, but increases the parse time, the bundle size, and the build time.</li>
<li><strong>It was inefficient for Node users.</strong> When running in Node, performing <code class="gatsby-code-text">process.env.NODE_ENV</code> checks before development-only code incurs the overhead of actually looking up environment variables. This slowed down React server rendering. We couldn’t cache it in a variable either because it prevented dead code elimination with Uglify.</li>
<li><strong>It broke encapsulation.</strong> React internals were exposed both in the open source (as <code class="gatsby-code-text">react-dom/lib/*</code> imports) and internally at Facebook. It was convenient at first as a way to share utilities between projects, but with time it became a maintenance burden because renaming or changing argument types of internal functions would break unrelated projects.</li>
<li><strong>It prevented experimentation.</strong> There was no way for the React team to experiment with any advanced compilation techniques. For example, in theory, we might want to apply <a href="https://developers.google.com/closure/compiler/docs/api-tutorial3">Google Closure Compiler Advanced</a> optimizations or <a href="https://prepack.io/">Prepack</a> to some of our code, but they are designed to work on complete bundles rather than small individual modules that we used to ship to npm.</li>
</ul>
<p>Due to these and other issues, we’ve changed the strategy in React 16. We still ship CommonJS modules for Node.js and bundlers, but instead of publishing many individual files in the npm package, we publish just two CommonJS bundles per entry point.</p>
<p>For example, when you import <code class="gatsby-code-text">react</code> with React 16, the bundler <a href="https://unpkg.com/react@16/index.js">finds the entry point</a> that just re-exports one of the two files:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cjs/react.production.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cjs/react.development.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>In every package provided by React, the <a href="https://unpkg.com/react@16/cjs/"><code class="gatsby-code-text">cjs</code> folder</a> (short for “CommonJS”) contains a development and a production pre-built bundle for each entry point. </p>
<p>For example, <a href="https://unpkg.com/react@16/cjs/react.development.js"><code class="gatsby-code-text">react.development.js</code></a> is the version intended for development. It is readable and includes comments. On the other hand, <a href="https://unpkg.com/react@16/cjs/react.production.min.js"><code class="gatsby-code-text">react.production.min.js</code></a> was minified and optimized before it was published to npm.</p>
<p>Note how this is essentially the same strategy that we’ve been using for the single-file browser builds (which now reside in the <a href="https://unpkg.com/react@16/umd/"><code class="gatsby-code-text">umd</code> directory</a>, short for <a href="https://www.davidbcalhoun.com/2014/what-is-amd-commonjs-and-umd/">Universal Module Definition</a>). Now we just apply the same strategy to the CommonJS builds as well.</p>
<h3 id="migrating-to-rollup"><a href="#migrating-to-rollup" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Migrating to Rollup</h3>
<p>Just compiling CommonJS modules into single-file bundles doesn’t solve all of the above problems. The really significant wins came from <a href="https://github.com/facebook/react/pull/9327">migrating our build system</a> from Browserify to <a href="https://rollupjs.org/">Rollup</a>.</p>
<p><a href="https://medium.com/webpack/webpack-and-rollup-the-same-but-different-a41ad427058c">Rollup was designed with libraries rather than apps in mind</a>, and it is a perfect fit for React’s use case. It solves one problem well: how to combine multiple modules into a flat file with minimal junk code in between. To achieve this, instead of turning modules into functions like many other bundlers, it puts all the code in the same scope, and renames variables so that they don’t conflict. This produces code that is easier for the JavaScript engine to parse, for a human to read, and for a minifier to optimize.</p>
<p>Rollup currently doesn’t support some features that are important to application builders, such as code splitting. However, it does not aim to replace tools like webpack that do a great job at this. Rollup is a perfect fit for <em>libraries</em> like React that can be pre-built and then integrated into apps.</p>
<p>You can find our Rollup build configuration <a href="https://github.com/facebook/react/blob/8ec146c38ee4f4c84b6ecf59f52de3371224e8bd/scripts/rollup/build.js#L336-L362">here</a>, with a <a href="https://github.com/facebook/react/blob/8ec146c38ee4f4c84b6ecf59f52de3371224e8bd/scripts/rollup/build.js#L196-L273">list of plugins we currently use</a>.</p>
<h3 id="migrating-to-google-closure-compiler"><a href="#migrating-to-google-closure-compiler" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Migrating to Google Closure Compiler</h3>
<p>After migrating to flat bundles, we <a href="https://github.com/facebook/react/pull/10236">started</a> using <a href="https://github.com/google/closure-compiler-js">the JavaScript version of the Google Closure Compiler</a> in its “simple” mode. In our experience, even with the advanced optimizations disabled, it still provided a significant advantage over Uglify, as it was able to better eliminate dead code and automatically inline small functions when appropriate.</p>
<p>At first, we could only use Google Closure Compiler for the React bundles we shipped in the open source. At Facebook, we still needed the checked-in bundles to be unminified so we could symbolicate React production crashes with our error reporting tools. We ended up contributing <a href="https://github.com/google/closure-compiler/pull/2707">a flag</a> that completely disables the renaming compiler pass. This lets us apply other optimizations like function inlining, but keep the code fully readable for the Facebook-specific builds of React. To improve the output readability, we <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/build.js#L249-L250">also format that custom build using Prettier</a>. Interestingly, running Prettier on production bundles while debugging the build process is a great way to find unnecessary code in the bundles!</p>
<p>Currently, all production React bundles <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/build.js#L235-L248">run through Google Closure Compiler in simple mode</a>, and we may look into enabling advanced optimizations in the future.</p>
<h3 id="protecting-against-weak-dead-code-elimination"><a href="#protecting-against-weak-dead-code-elimination" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Protecting Against Weak Dead Code Elimination</h3>
<p>While we use an efficient <a href="https://en.wikipedia.org/wiki/Dead_code_elimination">dead code elimination</a> solution in React itself, we can’t make a lot of assumptions about the tools used by the React consumers.</p>
<p>Typically, when you <a href="/reactdoc/docs/optimizing-performance.html#use-the-production-build">configure a bundler for production</a>, you need to tell it to substitute <code class="gatsby-code-text">process.env.NODE_ENV</code> with the <code class="gatsby-code-text">&quot;production&quot;</code> string literal. This process is sometimes called “envification”. Consider this code:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">"production"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// development-only code</span>
<span class="token punctuation">}</span></code></pre></div>
<p>After envification, this condition will always be <code class="gatsby-code-text">false</code>, and can be completely eliminated by most minifiers:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"production"</span> <span class="token operator">!==</span> <span class="token string">"production"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// development-only code</span>
<span class="token punctuation">}</span></code></pre></div>
<p>However, if the bundler is misconfigured, you can accidentally ship development code into production. We can’t completely prevent this, but we took a few steps to mitigate the common cases when it happens.</p>
<h4 id="protecting-against-late-envification"><a href="#protecting-against-late-envification" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Protecting Against Late Envification</h4>
<p>As mentioned above, our entry points now look like this:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cjs/react.production.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cjs/react.development.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>However, some bundlers process <code class="gatsby-code-text">require</code>s before envification. In this case, even if the <code class="gatsby-code-text">else</code> block never executes, the <code class="gatsby-code-text">cjs/react.development.js</code> file still gets bundled.</p>
<p>To prevent this, we also <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/rollup/wrappers.js#L65-L69">wrap the whole content</a> of the development bundle into another <code class="gatsby-code-text">process.env.NODE_ENV</code> check inside the <code class="gatsby-code-text">cjs/react.development.js</code> bundle itself:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token string">'use strict'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">"production"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// bundle code</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This way, even if the application bundle includes both the development and the production versions of the file, the development version will be empty after envification.</p>
<p>The additional <a href="https://en.wikipedia.org/wiki/Immediately-invoked_function_expression">IIFE</a> wrapper is necessary because some declarations (e.g. functions) can’t be placed inside an <code class="gatsby-code-text">if</code> statement in JavaScript.</p>
<h4 id="detecting-misconfigured-dead-code-elimination"><a href="#detecting-misconfigured-dead-code-elimination" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Detecting Misconfigured Dead Code Elimination</h4>
<p>Even though <a href="https://twitter.com/iamakulov/status/941336777188696066">the situation is changing</a>, many popular bundlers don’t yet force the users to specify the development or production mode. In this case <code class="gatsby-code-text">process.env.NODE_ENV</code> is typically provided by a runtime polyfill, but the dead code elimination doesn’t work.</p>
<p>We can’t completely prevent React users from misconfiguring their bundlers, but we introduced a few additional checks for this in <a href="https://github.com/facebook/react-devtools">React DevTools</a>.</p>
<p>If the development bundle executes, <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/packages/react-dom/src/client/ReactDOM.js#L1333-L1335">React DOM reports this to React DevTools</a>:</p>
<br>

  <span class="gatsby-resp-image-wrapper" style="position: relative; display: block;  max-width: 600px; margin-left: auto; margin-right: auto;">
    <span class="gatsby-resp-image-background-image" style="padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAABI0lEQVQY04WQ3XKCMBCFef+X6k2tkAIGRa1Ox5kOGiCAkt81gtINM73uudicTTaz324w/qfnn9Bi6u739nr9eX8rDvvAzLLWAlitNXqttFJq9to/WOsLAB7OPMfHNE3DOJqm7rsuSJKURITSLM/zMAw3m3WWZXEcRxFZpWmSovxJSPx9WHXNBcBJIWeQMbgwxmteMnY+nxl63vCm5byu8bKsGCs5523TFkXBWFVzXlXV6XQCgGEYAqSaCT2b0lIpibTaeGYAP5EUAiP4RAsh0HjyYXDOBYvFB11RhM2zr3BB42hN413yucvpcUOPOFG4XOJoOAAhZLfdK6mmWb7zvBvci9ES5A1kb2+duXVa9La/GiwFa6XE9gIB8cPr9cLo1+7cL+jygk7PcoV8AAAAAElFTkSuQmCC&apos;); background-size: cover; display: block;">
      <img class="gatsby-resp-image-image" style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;" alt="React DevTools on a website with development version of React" title="" src="/reactdoc/static/devtools-dev-e434ce2f7e64f63e597edf03f4465694-1e9b4.png" srcset="/reactdoc/static/devtools-dev-e434ce2f7e64f63e597edf03f4465694-1cd08.png 210w,
/reactdoc/static/devtools-dev-e434ce2f7e64f63e597edf03f4465694-9b07a.png 420w,
/reactdoc/static/devtools-dev-e434ce2f7e64f63e597edf03f4465694-1e9b4.png 600w" sizes="(max-width: 600px) 100vw, 600px">
    </span>
  </span>
  
<p>There is also one more bad scenario. Sometimes, <code class="gatsby-code-text">process.env.NODE_ENV</code> is set to <code class="gatsby-code-text">&quot;production&quot;</code> at runtime rather than at the build time. This is how it should work in Node.js, but it is bad for the client-side builds because the unnecessary development code is bundled even though it never executes. This is harder to detect but we found a heuristic that works well in most cases and doesn’t seem to produce false positives.</p>
<p>We can write a function that contains a <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/packages/react-dom/npm/index.js#L11-L20">development-only branch</a> with an arbitrary string literal. Then, if <code class="gatsby-code-text">process.env.NODE_ENV</code> is set to <code class="gatsby-code-text">&quot;production&quot;</code>, we can <a href="https://github.com/facebook/react-devtools/blob/b370497ba6e873c63479408f11d784095523a630/backend/installGlobalHook.js#L143">call <code class="gatsby-code-text">toString()</code> on that function</a> and verify that the string literal in the development-only has been stripped out. If it is still there, the dead code elimination didn’t work, and we need to warn the developer. Since developers might not notice the React DevTools warnings on a production website, we also <a href="https://github.com/facebook/react-devtools/blob/b370497ba6e873c63479408f11d784095523a630/backend/installGlobalHook.js#L153-L160">throw an error inside <code class="gatsby-code-text">setTimeout</code></a> from React DevTools in the hope that it will be picked up by the error analytics.</p>
<p>We recognize this approach is somewhat fragile. The <code class="gatsby-code-text">toString()</code> method is not reliable and may change its behavior in future browser versions. This is why we put that logic into React DevTools itself rather than into React. This allows us to remove it later if it becomes problematic. We also warn only if we <em>found</em> the special string literal rather than if we <em>didn’t</em> find it. This way, if the <code class="gatsby-code-text">toString()</code> output becomes opaque, or is overridden, the warning just won’t fire.</p>
<h2 id="catching-mistakes-early"><a href="#catching-mistakes-early" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Catching Mistakes Early</h2>
<p>We want to catch bugs as early as possible. However, even with our extensive test coverage, occasionally we make a blunder. We made several changes to our build and test infrastructure this year to make it harder to mess up.</p>
<h3 id="migrating-to-es-modules"><a href="#migrating-to-es-modules" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Migrating to ES Modules</h3>
<p>With the CommonJS <code class="gatsby-code-text">require()</code> and <code class="gatsby-code-text">module.exports</code>, it is easy to import a function that doesn’t really exist, and not realize that until you call it. However, tools like Rollup that natively support <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import"><code class="gatsby-code-text">import</code></a> and <a href="https://developer.mozilla.org/en-US/docs/web/javascript/reference/statements/export"><code class="gatsby-code-text">export</code></a> syntax fail the build if you mistype a named import. After releasing React 16, <a href="https://github.com/facebook/react/pull/11389">we have converted the entire React source code</a> to the ES Modules syntax.</p>
<p>Not only did this provide some extra protection, but it also helped improve the build size. Many React modules only export utility functions, but CommonJS forced us to wrap them into an object. By turning those utility functions into named exports and eliminating the objects that contained them, we let Rollup place them into the top-level scope, and thus let the minifier mangle their names in the production builds.</p>
<p>For now, have decided to only convert the source code to ES Modules, but not the tests. We use powerful utilities like <code class="gatsby-code-text">jest.resetModules()</code> and want to retain tighter control over when the modules get initialized in tests. In order to consume ES Modules from our tests, we enabled the <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/jest/preprocessor.js#L28-L29">Babel CommonJS transform</a>, but only for the test environment.</p>
<h3 id="running-tests-in-production-mode"><a href="#running-tests-in-production-mode" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running Tests in Production Mode</h3>
<p>Historically, we’ve been running all tests in a development environment. This let us assert on the warning messages produced by React, and seemed to make general sense. However, even though we try to keep the differences between the development and production code paths minimal, occasionally we would make a mistake in production-only code branches that weren’t covered by tests, and cause an issue at Facebook.</p>
<p>To solve this problem, we have added a new <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/package.json#L110"><code class="gatsby-code-text">yarn test-prod</code></a> command that runs on CI for every pull request, and <a href="https://github.com/facebook/react/pull/11616">executes all React test cases in the production mode</a>. We wrapped any assertions about warning messages into development-only conditional blocks in all tests so that they can still check the rest of the expected behavior in both environments. Since we have a custom Babel transform that replaces production error messages with the <a href="/reactdoc/blog/2016/07/11/introducing-reacts-error-code-system.html">error codes</a>, we also added a <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/jest/setupTests.js#L91-L126">reverse transformation</a> as part of the production test run.</p>
<h3 id="using-public-api-in-tests"><a href="#using-public-api-in-tests" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Public API in Tests</h3>
<p>When we were <a href="https://code.facebook.com/posts/1716776591680069/react-16-a-look-inside-an-api-compatible-rewrite-of-our-frontend-ui-library/">rewriting the React reconciler</a>, we recognized the importance of writing tests against the public API instead of internal modules. If the test is written against the public API, it is clear what is being tested from the user’s perspective, and you can run it even if you rewrite the implementation from scratch.</p>
<p>We reached out to the wonderful React community <a href="https://github.com/facebook/react/issues/11299">asking for help</a> converting the remaining tests to use the public API. Almost all of the tests are converted now! The process wasn’t easy. Sometimes a unit test just calls an internal method, and it’s hard to figure out what the observable behavior from user’s point of view was supposed to be tested. We found a few strategies that helped with this. The first thing we would try is to find the git history for when the test was added, and find clues in the issue and pull request description. Often they would contain reproducing cases that ended up being more valuable than the original unit tests! A good way to verify the guess is to try commenting out individual lines in the source code being tested. If the test fails, we know for sure that it stresses the given code path.</p>
<p>We would like to give our deepest thanks to <a href="https://github.com/facebook/react/issues?q=is%3Apr+11299+is%3Aclosed">everyone who contributed to this effort</a>.</p>
<h3 id="running-tests-on-compiled-bundles"><a href="#running-tests-on-compiled-bundles" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running Tests on Compiled Bundles</h3>
<p>There is also one more benefit to writing tests against the public API: now we can <a href="https://github.com/facebook/react/pull/11633">run them against the compiled bundles</a>.</p>
<p>This helps us ensure that tools like Babel, Rollup, and Google Closure Compiler don’t introduce any regressions. This also opens the door for future more aggressive optimizations, as we can be confident that React still behaves exactly as expected after them.</p>
<p>To implement this, we have created a <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/jest/config.build.js">second Jest config</a>. It overrides our default config but points <code class="gatsby-code-text">react</code>, <code class="gatsby-code-text">react-dom</code>, and other entry points to the <code class="gatsby-code-text">/build/packages/</code> folder. This folder doesn’t contain any React source code, and reflects what gets published to npm. It is populated after you run <code class="gatsby-code-text">yarn build</code>.</p>
<p>This lets us run the same exact tests that we normally run against the source, but execute them using both development and production pre-built React bundles produced with Rollup and Google Closure Compiler.</p>
<p>Unlike the normal test run, the bundle test run depends on the build products so it is not great for quick iteration. However, it still runs on the CI server so if something breaks, the test will display as failed, and we will know it’s not safe to merge into master.</p>
<p>There are still some test files that we intentionally don’t run against the bundles. Sometimes we want to mock an internal module or override a feature flag that isn’t exposed to the public yet. For those cases, we blacklist a test file by renaming it from <code class="gatsby-code-text">MyModule-test.js</code> to <code class="gatsby-code-text">MyModule-test.internal.js</code>.</p>
<p>Currently, over 93% out of 2,650 React tests run against the compiled bundles.</p>
<h3 id="linting-compiled-bundles"><a href="#linting-compiled-bundles" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Linting Compiled Bundles</h3>
<p>In addition to linting our source code, we run a much more limited set of lint rules (really, <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/validate/eslintrc.cjs.js#L26-L27">just two of them</a>) on the compiled bundles. This gives us an extra layer of protection against regressions in the underlying tools and <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/validate/eslintrc.cjs.js#L22">ensures</a> that the bundles don’t use any language features that aren’t supported by older browsers.</p>
<h3 id="simulating-package-publishing"><a href="#simulating-package-publishing" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simulating Package Publishing</h3>
<p>Even running the tests on the built packages is not enough to avoid shipping a broken update. For example, we use the <code class="gatsby-code-text">files</code> field in our <code class="gatsby-code-text">package.json</code> files to specify a whitelist of folders and files that should be published on npm. However, it is easy to add a new entry point to a package but forget to add it to the whitelist. Even the bundle tests would pass, but after publishing the new entry point would be missing.</p>
<p>To avoid situations like this, we are now simulating the npm publish by <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/packaging.js#L129-L134">running <code class="gatsby-code-text">npm pack</code> and then immediately unpacking the archive</a> after the build. Just like <code class="gatsby-code-text">npm publish</code>, this command filters out anything that isn’t in the <code class="gatsby-code-text">files</code> whitelist. With this approach, if we were to forget adding an entry point to the list, it would be missing in the build folder, and the bundle tests relying on it would fail.</p>
<h3 id="creating-manual-test-fixtures"><a href="#creating-manual-test-fixtures" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating Manual Test Fixtures</h3>
<p>Our unit tests run only in the Node environment, but not in the browsers. This was an intentional decision because browser-based testing tools were flaky in our experience, and didn’t catch many issues anyway.</p>
<p>We could get away with this because the code that touches the DOM is consolidated in a few files, and doesn’t change that often. Every week, we update the Facebook.com codebase to the latest React commit on master. At Facebook, we use a set of internal <a href="http://www.seleniumhq.org/projects/webdriver/">WebDriver</a> tests for critical product workflows, and these catch some regressions. React updates are first delivered to employees, so severe bugs get reported immediately before they reach two billion users.</p>
<p>Still, it was hard to review DOM-related changes, and occasionally we would make mistakes. In particular, it was hard to remember all the edge cases that the code had to handle, why they were added, and when it was safe to remove them. We considered adding some automatic tests that run in the browser but we didn’t want to slow down the development cycle and deal with a fragile CI. Additionally, automatic tests don’t always catch DOM issues. For example, an input value displayed by the browser may not match what it reports as a DOM property.</p>
<p>We’ve chatted about this with <a href="https://github.com/aweary">Brandon Dail</a>, <a href="https://github.com/jquense">Jason Quense</a>, and <a href="https://github.com/nhunzaker">Nathan Hunzaker</a>. They were sending substantial patches to React DOM but were frustrated that we failed to review them timely. We decided to give them commit access, but asked them to <a href="https://github.com/facebook/react/pull/8589">create a set of manual tests</a> for DOM-related areas like input management. The initial set of manual fixtures <a href="https://github.com/facebook/react/commits/master/fixtures/dom">kept growing</a> over the year.</p>
<p>These fixtures are implemented as a React app located in <a href="https://github.com/facebook/react/tree/d906de7f602df810c38aa622c83023228b047db6/fixtures/dom"><code class="gatsby-code-text">fixtures/dom</code></a>. Adding a fixture involves writing a React component with a description of the expected behavior, and links to the appropriate issues and browser quirks, like <a href="https://github.com/facebook/react/pull/11760">in this example</a>:</p>
<img src="https://user-images.githubusercontent.com/590904/33555298-dd52fb4e-d8cd-11e7-80e9-8369538eb633.png" style="max-width:100%" alt="DOM fixture example">
<p>The fixture app lets you choose a version of React (local or one of the published versions) which is handy for comparing the behavior before and after the changes. When we change the behavior related to how we interact with the DOM, we can verify that it didn’t regress by going through the related fixtures in different browsers.</p>
<p>In some cases, a change proved to be so complex that it necessitated a standalone purpose-built fixture to verify it. For example, the <a href="/reactdoc/blog/2017/09/08/dom-attributes-in-react-16.html">DOM attribute handling in React 16</a> was very hard to pull off with confidence at first. We kept discovering different edge cases, and almost gave up on doing it in time for the React 16 release. However, then we’ve built an <a href="https://github.com/facebook/react/tree/d906de7f602df810c38aa622c83023228b047db6/fixtures/attribute-behavior">“attribute table” fixture</a> that renders all supported attributes and their misspellings with previous and next version of React, and displays the differences. It took a few iterations (the key insight was to group attributes with similar behavior together) but it ultimately allowed us to fix all major issues in just a few days.</p>
<br>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">We went through the table to vet the new behavior for every case (and discovered some old bugs too) <a href="https://t.co/cmF2qnK9Q9">pic.twitter.com/cmF2qnK9Q9</a></p>&mdash; Dan Abramov (@dan_abramov) <a href="https://twitter.com/dan_abramov/status/906244378066345984?ref_src=twsrc%5Etfw">September 8, 2017</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Going through the fixtures is still a lot of work, and we are considering automating some of it. Still, the fixture app is invaluable even as documentation for the existing behavior and all the edge cases and browser bugs that React currently handles. Having it gives us confidence in making significant changes to the logic without breaking important use cases. Another improvement we’re considering is to have a GitHub bot build and deploy the fixtures automatically for every pull request that touches the relevant files so anyone can help with browser testing.</p>
<h3 id="preventing-infinite-loops"><a href="#preventing-infinite-loops" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Preventing Infinite Loops</h3>
<p>The React 16 codebase contains many <code class="gatsby-code-text">while</code> loops. They let us avoid the dreaded deep stack traces that occurred with earlier versions of React, but can make development of React really difficult. Every time there is a mistake in an exit condition our tests would just hang, and it took a while to figure out which of the loops is causing the issue.</p>
<p>Inspired by the <a href="https://repl.it/site/blog/infinite-loops">strategy adopted by Repl.it</a>, we have added a <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/babel/transform-prevent-infinite-loops.js">Babel plugin that prevents infinite loops</a> in the test environment. If some loop continues for more than the maximum allowed number of iterations, we throw an error and immediately fail it so that Jest can display where exactly this happened.</p>
<p>This approach has a pitfall. If an error thrown from the Babel plugin gets caught and ignored up the call stack, the test will pass even though it has an infinite loop. This is really, really bad. To solve this problem, we <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/babel/transform-prevent-infinite-loops.js#L26-L30">set a global field</a> before throwing the error. Then, after every test run, we <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/jest/setupTests.js#L42-L56">rethrow that error if the global field has been set</a>. This way any infinite loop will cause a test failure, no matter whether the error from the Babel plugin was caught or not.</p>
<h2 id="customizing-the-build"><a href="#customizing-the-build" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Customizing the Build</h2>
<p>There were a few things that we had to fine-tune after introducing our new build process. It took us a while to figure them out, but we’re moderately happy with the solutions that we arrived at.</p>
<h3 id="dead-code-elimination"><a href="#dead-code-elimination" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dead Code Elimination</h3>
<p>The combination of Rollup and Google Closure Compiler already gets us pretty far in terms of stripping development-only code in production bundles. We <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/build.js#L223-L226">replace</a> the <code class="gatsby-code-text">__DEV__</code> literal with a boolean constant during the build, and both Rollup together and Google Closure Compiler can strip out the <code class="gatsby-code-text">if (false) {}</code> code branches and even some more sophisticated patterns. However, there is one particularly nasty case:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">import</span> warning <span class="token keyword">from</span> <span class="token string">'fbjs/lib/warning'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">warning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">'Blimey!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>This pattern is very common in the React source code. However <code class="gatsby-code-text">fbjs/lib/warning</code> is an external import that isn’t being bundled by Rollup for the CommonJS bundle. Therefore, even if <code class="gatsby-code-text">warning()</code> call ends up being removed, Rollup doesn’t know whether it’s safe to remove to the import itself. What if the module performs a side effect during initialization? Then removing it would not be safe.</p>
<p>To solve this problem, we use the <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/build.js#L338-L340"><code class="gatsby-code-text">treeshake.pureExternalModules</code> Rollup option</a> which takes an array of modules that we can guarantee don’t have side effects. This lets Rollup know that an import to <code class="gatsby-code-text">fbjs/lib/warning</code> is safe to completely strip out if its value is not being used. However, if it <em>is</em> being used (e.g. if we decide to add warnings in production), the import will be preserved. That’s why this approach is safer than replacing modules with empty shims.</p>
<p>When we optimize something, we need to ensure it doesn’t regress in the future. What if somebody introduces a new development-only import of an external module, and not realize they also need to add it to <code class="gatsby-code-text">pureExternalModules</code>? Rollup prints a warning in such cases but we’ve <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/build.js#L395-L412">decided to fail the build completely</a> instead. This forces the person adding a new external development-only import to <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/modules.js#L10-L22">explicitly specify whether it has side effects or not</a> every time.</p>
<h3 id="forking-modules"><a href="#forking-modules" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Forking Modules</h3>
<p>In some cases, different bundles need to contain slightly different code. For example, React Native bundles have a different error handling mechanism that shows a redbox instead of printing a message to the console. However, it can be very inconvenient to thread these differences all the way through the calling modules.</p>
<p>Problems like this are often solved with runtime configuration. However, sometimes it is impossible: for example, the React DOM bundles shouldn’t even attempt to import the React Native redbox helpers. It is also unfortunate to bundle the code that never gets used in a particular environment.</p>
<p>Another solution is to use dynamic dependency injection. However, it often produces code that is hard to understand, and may cause cyclical dependencies. It also defies some optimization opportunities.</p>
<p>From the code point of view, ideally we just want to “redirect” a module to its different “forks” for specific bundles. The “forks” have the exact same API as the original modules, but do something different. We found this mental model very intuitive, and <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/forks.js">created a fork configuration file</a> that specifies how the original modules map to their forks, and the conditions under which this should happen.</p>
<p>For example, this fork config entry specifies different <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/shared/ReactFeatureFlags.js">feature flags</a> for different bundles:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token string">'shared/ReactFeatureFlags'</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>bundleType<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'react-native-renderer'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'shared/forks/ReactFeatureFlags.native.js'</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'react-cs-renderer'</span><span class="token punctuation">:</span>
      <span class="token keyword">return</span> <span class="token string">'shared/forks/ReactFeatureFlags.native-cs.js'</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span>bundleType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">FB_DEV</span><span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token constant">FB_PROD</span><span class="token punctuation">:</span>
          <span class="token keyword">return</span> <span class="token string">'shared/forks/ReactFeatureFlags.www.js'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre></div>
<p>During the build, <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/scripts/rollup/plugins/use-forks-plugin.js#L40">our custom Rollup plugin</a> replaces modules with their forks if the conditions have matched. Since both the original modules and the forks are written as ES Modules, Rollup and Google Closure Compiler can inline constants like numbers or booleans, and thus efficiently eliminate dead code for disabled feature flags. In tests, when necessary, we <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/react-cs-renderer/src/__tests__/ReactNativeCS-test.internal.js#L15-L17">use <code class="gatsby-code-text">jest.mock()</code></a> to point the module to the appropriate forked version.</p>
<p>As a bonus, we might want to verify that the export types of the original modules match the export types of the forks exactly. We can use a <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/shared/forks/ReactFeatureFlags.native.js#L32-L36">slightly odd but totally working Flow trick</a> to accomplish this:</p>
<div class="gatsby-highlight" data-language="jsx"><pre class="gatsby-code-jsx"><code class="gatsby-code-jsx"><span class="token keyword">import</span> <span class="token keyword">typeof</span> <span class="token operator">*</span> <span class="token keyword">as</span> FeatureFlagsType <span class="token keyword">from</span> <span class="token string">'shared/ReactFeatureFlags'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">typeof</span> <span class="token operator">*</span> <span class="token keyword">as</span> FeatureFlagsShimType <span class="token keyword">from</span> <span class="token string">'./ReactFeatureFlags.native'</span><span class="token punctuation">;</span>
type Check<span class="token operator">&lt;</span>_X<span class="token punctuation">,</span> <span class="token constant">Y</span><span class="token punctuation">:</span> _X<span class="token punctuation">,</span> <span class="token constant">X</span><span class="token punctuation">:</span> <span class="token constant">Y</span> <span class="token operator">=</span> _X<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">:</span> Check<span class="token operator">&lt;</span>FeatureFlagsShimType<span class="token punctuation">,</span> FeatureFlagsType<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>This works by essentially forcing Flow to verify that two types are assignable to each other (and thus are equivalent). Now if we modify the exports of either the original module or the fork without changing the other file, the type check will fail. This might be a little goofy but we found this helpful in practice.</p>
<p>To conclude this section, it is important to note that you can’t specify your own module forks if you consume React from npm. This is intentional because none of these files are public API, and they are not covered by the <a href="https://semver.org/">semver</a> guarantees. However, you are always welcome to build React from master or even fork it if you don’t mind the instability and the risk of divergence. We hope that this writeup was still helpful in documenting one possible approach to targeting different environments from a single JavaScript library.</p>
<h3 id="tracking-bundle-size"><a href="#tracking-bundle-size" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Tracking Bundle Size</h3>
<p>As a final build step, we now <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/rollup/build.js#L264-L272">record build sizes for all bundles</a> and write them to a file that <a href="https://github.com/facebook/react/blob/d906de7f602df810c38aa622c83023228b047db6/scripts/rollup/results.json">looks like this</a>. When you run <code class="gatsby-code-text">yarn build</code>, it prints a table with the results:</p>
<br>
<img src="https://user-images.githubusercontent.com/1519870/28427900-80487dbc-6d6f-11e7-828d-1b594bd1ddb5.png" style="max-width:100%" alt="Build results after running GCC">
<p><em>(It doesn’t always look as good as this. This was the commit that migrated React from Uglify to Google Closure Compiler.)</em></p>
<p>Keeping the file sizes committed for everyone to see was helpful for tracking size changes and motivating people to find optimization opportunities.</p>
<p>We haven’t been entirely happy with this strategy because the JSON file often causes merge conflicts on larger branches. Updating it is also not currently enforced so it gets out of date. In the future, we’re considering integrating a bot that would comment on pull requests with the size changes.</p>
<h2 id="simplifying-the-release-process"><a href="#simplifying-the-release-process" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Simplifying the Release Process</h2>
<p>We like to release updates to the open source community often. Unfortunately, the old process of creating a release was slow and would typically take an entire day. After some changes to this process, we’re now able to do a full release in less than an hour. Here’s what we changed.</p>
<h3 id="branching-strategy"><a href="#branching-strategy" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Branching Strategy</h3>
<p>Most of the time spent in the old release process was due to our branching strategy. The <code class="gatsby-code-text">master</code> branch was assumed to be unstable and would often contain breaking changes. Releases were done from a <code class="gatsby-code-text">stable</code> branch, and changes were manually cherry-picked into this branch prior to a release. We had <a href="https://github.com/facebook/react/pull/7330">tooling to help automate</a> some of this process, but it was still <a href="https://github.com/facebook/react/blob/b5a2a1349d6e804d534f673612357c0be7e1d701/scripts/release-manager/Readme.md">pretty complicated to use</a>.</p>
<p>As of version 16, we now release from the <code class="gatsby-code-text">master</code> branch. Experimental features and breaking changes are allowed, but must be hidden behind <a href="https://github.com/facebook/react/blob/cc52e06b490e0dc2482b345aa5d0d65fae931095/packages/shared/ReactFeatureFlags.js">feature flags</a> so they can be removed during the build process. The new flat bundles and dead code elimination make it possible for us to do this without fear of leaking unwanted code into open source builds.</p>
<h3 id="automated-scripts"><a href="#automated-scripts" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Automated Scripts</h3>
<p>After changing to a stable <code class="gatsby-code-text">master</code>, we created a new <a href="https://github.com/facebook/react/issues/10620">release process checklist</a>. Although much simpler than the previous process, this still involved dozens of steps and forgetting one could result in a broken release.</p>
<p>To address this, we created a new <a href="https://github.com/facebook/react/pull/11223">automated release process</a> that is <a href="https://github.com/facebook/react/tree/master/scripts/release#react-release-script">much easier to use</a> and has several built-in checks to ensure that we release a working build. The new process is split into two steps: <em>build</em> and <em>publish</em>. Here’s what it looks like the first time you run it:</p>
<p>
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 822px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 45.37712895377128%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9ElEQVQoz41S7W6EIBDUqgunIp9i0Yo5Mdr3f8IO7Z8mvfY6IZsJzrA7YOHG0XuvjXHOGcD5XMbMq6oq/gYZR9rx8ZWkyVXZoiyLf+KlISySuukHpkx967BZfuK5WUo5eT8MgzF6EAKkaZqfssdn7fuulPr6DBsxRkRIC0qUOfBrZ7S6Z+wg87xc1/txHOd5ppRCCDHGbdu0Uri/BxPNIfjJY/iu6zjnbXtjjPV9X9f188x4pzVGvNM0TTAzhsLRpG1bTI5Ey/JmrcUUQgjGWfE9O6Rb3KBYVxySx8S1wQkp0lprsAPneV4pHZCgh9b4LQxifgAFAxQ1QzKDmQAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Release Script overview"
        title=""
        src="/reactdoc/static/release-script-build-overview-adca79c3a0e003b317fe62e68ce9d4a0-a0a5f.png"
        srcset="/reactdoc/static/release-script-build-overview-adca79c3a0e003b317fe62e68ce9d4a0-d0a04.png 210w,
/reactdoc/static/release-script-build-overview-adca79c3a0e003b317fe62e68ce9d4a0-c8d6c.png 420w,
/reactdoc/static/release-script-build-overview-adca79c3a0e003b317fe62e68ce9d4a0-a0a5f.png 822w"
        sizes="(max-width: 822px) 100vw, 822px"
      />
    </span>
  </span>
  </p>
<p>The <em>build</em> step does most of the work- verifying permissions, running tests, and checking CI status. Once it finishes, it prints a reminder to update the CHANGELOG and to verify the bundle using the <a href="#creating-manual-test-fixtures">manual fixtures</a> described above.</p>
<p>
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 95.52407932011332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAIAAAAf7rriAAAACXBIWXMAAAsSAAALEgHS3X78AAAByUlEQVQ4y5VT2Y6jMBAEbALm8oVtjG0CmUQZzf9/4BTkabUrki01zSEV1V3dzrQZU0rbZmNQxlhnnRCibduhH5qmuVwur5z9E2rSXzvWdU2gEVLkeZ59COXUbbvFlGJMUqrsv6Anva1bCDPnvG07wUXf93imtPxEGeTbsixuckLu3aJJ5KIoPiDbnRxC8LOXSrIDwzB03a5fVdUZude985O22tpBKQ5VKIMMcdRflqfFM8Va3TDZlCUtihzVUkry/V4QQiilZ+ShG5TUozbWWq31eEApBVlMDvms+X43d+BwWQg0iYLxAbbXdY3deDPz+gBMQm67HWj7UoFYoeY3ZFQ4TRNqjjEiw6HTPvM/whjjnPPehzmgWyhDdDeL0uIFgis/3v76FZhzCM5NWE/8Jy3XGBfBpRBSKWQjxCxklCpwEapa1mysmW7aibExwz57D+bkvV2WcByhAkEI1CjZlxSKBJEXUEeUexBURzMhJZj3u3k+7fe3Naa2hhnDpOxenp8ZZszoZ5zodLuln5/H4/G0brmuDxxtCL/Zbc6l1jMXUenN2Icx2zhea6ZeM3ozKu/Fuun7l15XaUy3JGHGXuv2GHiDfHI2fgHOzScpC1PdigAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Release Script build confirmation screen"
        title=""
        src="/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-acf85.png"
        srcset="/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-c1418.png 210w,
/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-5d5d8.png 420w,
/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-acf85.png 840w,
/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-de0cd.png 1260w,
/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-bd6c2.png 1680w,
/reactdoc/static/release-script-build-confirmation-17f44f353d82a22f6a18707956ad065f-d15b8.png 1765w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  </p>
<p>All that’s left is to tag and publish the release to NPM using the <em>publish</em> script.</p>
<p>
  <span
    class="gatsby-resp-image-wrapper"
    style="position: relative; display: block;  max-width: 840px; margin-left: auto; margin-right: auto;"
  >
    <span
      class="gatsby-resp-image-background-image"
      style="padding-bottom: 125.12733446519523%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAIAAAC+dZmEAAAACXBIWXMAAAsSAAALEgHS3X78AAACtElEQVQ4y41UCXKjMBD0wSUJiUMCXRgBPpJ4P7D7/49tIza1sStV8SQ1BTI9R0+PdtrqeV7GMcwhTONonTudTt77qqqaaG3bKtXBM8YoY3VdU0qzLCvLcscbPo2TNU513vhZWwvA8XjcvWJMMWWVNCrvzL6yhIlKiN2LRi3LuyJXBfOkqNP1aL8/fLH9+nrEA8qBfwBzxmtRt/gTaE9xITjn6Keq0XVVNzWe0S0OlVJCiAc8PgKo5LxuGnwBMrYMx2hJkmz5vy8bmK7rAGNlKaMJUYFS5EQqrXXbroQTQrZAD+CtQkJJQQhq3ooso6FIBCk/X/M8T9P0sWfOm7ah0ZANgK1DLjhm1use+Cra1hT4+wIWYgOgMB4NiUSFea3M4TCPBlUUBYojD5VvPCH85tc88Rl14usf5uy8l7L10cIYhmEIYUxeVBi4Bd5aG0IwxjjvWjl1/Zvq3qp6IcwzPpd8omygpWN8LPmYpOwfGHO6XC7Lslyv1zCO8xJut+n+6+3jY/rze7zf9ekEntKiANNZlq+NQwSf8qRUKokQzrmu60Nwg0c1B0IwxQIkd4ooWWBShGKpGE7+D6zre4gBNU/TZKyFV0qCNhABvr/O5RtDn0g7zTM22Vrnh0Gb2dhpGK7whMo8q7Jc5HmVZWJ/SJ4V1muN5M5V86ymSY6j0brTZilIm2V1QWReNHnR4vVweFQYxhpLVbhObreztf2y+Pf3xWiVpskPo+pjz/BgC2XD40qihG6/Ypc//9e9xsEzGKvj1obR8er94Dcxwv90k1DmHEQmtUZOXIAe4Ovter/fPzBl8Ilw3qM6eMj2SWGij2YMrlFcpDN2C6u7rQrohNgxdzxjfs9qRzZEP5/PGBWwUBsCvXoBIoOUCisNtcQrWmGNoRnEQgcIvS5MCNjKyN8DYX8BX7tGg3ZkvyoAAAAASUVORK5CYII='); background-size: cover; display: block;"
    >
      <img
        class="gatsby-resp-image-image"
        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"
        alt="Release Script publish confirmation screen"
        title=""
        src="/reactdoc/static/release-script-publish-confirmation-a3846d4b3e50d29415846b58612310f2-acf85.png"
        srcset="/reactdoc/static/release-script-publish-confirmation-a3846d4b3e50d29415846b58612310f2-c1418.png 210w,
/reactdoc/static/release-script-publish-confirmation-a3846d4b3e50d29415846b58612310f2-5d5d8.png 420w,
/reactdoc/static/release-script-publish-confirmation-a3846d4b3e50d29415846b58612310f2-acf85.png 840w,
/reactdoc/static/release-script-publish-confirmation-a3846d4b3e50d29415846b58612310f2-bd35c.png 1178w"
        sizes="(max-width: 840px) 100vw, 840px"
      />
    </span>
  </span>
  </p>
<p>(You may have noticed a <code class="gatsby-code-text">--dry</code> flag in the screenshots above. This flag allows us to run a release, end-to-end, without actually publishing to NPM. This is useful when working on the release script itself.)</p>
<h2 id="in-conclusion"><a href="#in-conclusion" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>In Conclusion</h2>
<p>Did this post inspire you to try some of these ideas in your own projects? We certainly hope so! If you have other ideas about how React build, test, or contribution workflow could be improved, please let us know on <a href="https://github.com/facebook/react/issues">our issue tracker</a>.</p>
<p>You can find the related issues by the <a href="https://github.com/facebook/react/labels/Component%3A%20Build%20Infrastructure">build infrastructure label</a>. These are often great first contribution opportunities!</p>
<h2 id="acknowledgements"><a href="#acknowledgements" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Acknowledgements</h2>
<p>We would like to thank:</p>
<ul>
<li><a href="https://github.com/Rich-Harris">Rich Harris</a> and <a href="https://github.com/lukastaegert">Lukas Taegert</a> for maintaining Rollup and helping us integrate it.</li>
<li><a href="https://github.com/dimvar">Dimitris Vardoulakis</a>, <a href="https://github.com/ChadKillingsworth">Chad Killingsworth</a>, and <a href="https://github.com/MatrixFrog">Tyler Breisacher</a> for their work on Google Closure Compiler and timely advice.</li>
<li><a href="https://github.com/watadarkstar">Adrian Carolli</a>, <a href="https://github.com/rivenhk">Adams Au</a>, <a href="https://github.com/accordeiro">Alex Cordeiro</a>, <a href="https://github.com/HeroProtagonist">Jordan Tepper</a>, <a href="https://github.com/sjy">Johnson Shi</a>, <a href="https://github.com/misoguy">Soo Jae Hwang</a>, <a href="https://github.com/xjlim">Joe Lim</a>, <a href="https://github.com/yu-tian113">Yu Tian</a>, and others for helping prototype and implement some of these and other improvements.</li>
<li><a href="https://github.com/anushreesubramani">Anushree Subramani</a>, <a href="https://github.com/abiduzz420">Abid Uzair</a>, <a href="https://github.com/skiritsis">Sotiris Kiritsis</a>, <a href="https://github.com/timjacobi">Tim Jacobi</a>, <a href="https://github.com/aarboleda1">Anton Arboleda</a>, <a href="https://github.com/jeremenichelli">Jeremias Menichelli</a>, <a href="https://github.com/audyodi">Audy Tanudjaja</a>, <a href="https://github.com/gordyd">Gordon Dent</a>, <a href="https://github.com/enapupe">Iacami Gevaerd
</a>, <a href="https://github.com/sadpandabear">Lucas Lentz</a>, <a href="https://github.com/silvestrijonathan">Jonathan Silvestri</a>, <a href="https://github.com/mjw56">Mike Wilcox</a>, <a href="https://github.com/smaniotto">Bernardo Smaniotto</a>, <a href="https://github.com/douglasgimli">Douglas Gimli</a>, <a href="https://github.com/ethan-arrowood">Ethan Arrowood</a>, and others for their help porting the React test suite to use the public API.</li>
</ul>]]></description><link>https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html</link><guid isPermaLink="false">https://reactjs.org/blog/2017/12/15/improving-the-repository-infrastructure.html</guid><pubDate>Fri, 15 Dec 2017 08:00:00 GMT</pubDate></item><item><title><![CDATA[Introducing the React RFC Process]]></title><description><![CDATA[<p>We’re adopting an RFC (“request for comments”) process for contributing ideas to React. </p>
<p>Inspired by <a href="https://github.com/yarnpkg/rfcs">Yarn</a>, <a href="https://github.com/emberjs/rfcs">Ember</a>, and <a href="https://github.com/rust-lang/rfcs">Rust</a>, the goal is to allow React core team members and community members to collaborate on the design of new features. It’s also intended to provide a clear path for ideas to enter the project:</p>
<ul>
<li>Create an RFC document detailing your proposal.</li>
<li>Submit a PR to the <a href="https://github.com/reactjs/rfcs">RFC repository</a>.</li>
<li>Incorporate feedback into the proposal.</li>
<li>After discussion, the core team may or may not accept the RFC.</li>
<li>If the RFC is accepted, the PR is merged.</li>
</ul>
<p>RFCs are accepted when they are approved for implementation in React. A more thorough description of the process is available in the repository’s <a href="https://github.com/reactjs/rfcs/blob/master/README.md">README</a>. The exact details may be refined in the future.</p>
<h2 id="who-can-submit-rfcs"><a href="#who-can-submit-rfcs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Who Can Submit RFCs?</h2>
<p>Anyone! No knowledge of React’s internals is required, nor are you expected to implement the proposal yourself.</p>
<p>As with our other repositories, we do ask that you complete a <a href="https://github.com/reactjs/rfcs#contributor-license-agreement-cla">Contributor License Agreement</a> before we can accept your PR.</p>
<h2 id="what-types-of-changes-should-be-submitted-as-rfcs"><a href="#what-types-of-changes-should-be-submitted-as-rfcs" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>What Types of Changes Should Be Submitted As RFCs?</h2>
<p>Generally, any idea that would benefit from additional review or design before being implemented is a good candidate for an RFC. As a rule of thumb, this means any proposal that adds, changes, or removes a React API.</p>
<p>Not every change must go through the RFC process. Bug fixes or performance improvements that don’t touch the API can be submitted directly to the main library.</p>
<p>We now have several repositories where you can submit contributions to React:</p>
<ul>
<li><strong>Issues, bugfixes, and code changes to the main library</strong>: <a href="https://github.com/facebook/react">facebook/react</a></li>
<li><strong>Website and documentation</strong>: <a href="https://github.com/reactjs/reactjs.org">reactjs/reactjs.org</a></li>
<li><strong>Ideas for changes that need additional review before being implemented</strong>: <a href="https://github.com/reactjs/rfcs">reactjs/rfcs</a></li>
</ul>
<h2 id="rfc-for-a-new-context-api"><a href="#rfc-for-a-new-context-api" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RFC for A New Context API</h2>
<p>Coinciding with the launch of our RFC process, we’ve submitted a <a href="https://github.com/reactjs/rfcs/pull/2">proposal for a new version of context</a>. The proposal has already received many valuable comments from the community that we will incorporate into the design of the new API.</p>
<p>The context PR is a good example of how a typical RFC should be structured. We’re excited to start receiving your proposals!</p>]]></description><link>https://reactjs.org/blog/2017/12/07/introducing-the-react-rfc-process.html</link><guid isPermaLink="false">https://reactjs.org/blog/2017/12/07/introducing-the-react-rfc-process.html</guid><pubDate>Thu, 07 Dec 2017 08:00:00 GMT</pubDate></item></channel></rss>